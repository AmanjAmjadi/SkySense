<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkySense Weather App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.30.0/tabler-icons.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .weather-icon {
            font-size: 4rem;
            text-align: center;
        }
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(93, 92, 222, 0.3);
            border-radius: 50%;
            border-top-color: #5D5CDE;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Dark mode styles */
        .dark .weather-card {
            background-color: #2d2d2d;
            color: #f1f1f1;
        }
        .dark .input-field {
            background-color: #3d3d3d;
            color: #ffffff;
        }
        #map { 
            height: 300px; 
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1; /* Ensure proper z-index for map controls */
        }
        .forecast-container {
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #5D5CDE #f0f0f0;
        }
        .forecast-container::-webkit-scrollbar {
            height: 8px;
        }
        .forecast-container::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }
        .forecast-container::-webkit-scrollbar-thumb {
            background-color: #5D5CDE;
            border-radius: 4px;
        }
        .dark .forecast-container::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        .location-tab {
            position: relative;
            cursor: pointer;
        }
        .location-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #5D5CDE;
        }
        .dark .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }
        .dark .leaflet-container {
            background: #333;
        }
        
        /* Ad container styles */
        .ad-container {
            background-color: #f9f9f9;
            border-radius: 0.5rem;
            margin: 1rem 0;
            padding: 1rem;
            text-align: center;
            overflow: hidden;
        }
        .dark .ad-container {
            background-color: #2d2d2d;
        }
        .ad-container.horizontal {
            min-height: 90px;
        }
        .ad-container.square {
            min-height: 250px;
        }
        .ad-label {
            display: block;
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.25rem;
        }
        .dark .ad-label {
            color: #aaa;
        }
        
        /* Autocomplete styles */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .dark .autocomplete-items {
            border-color: #555;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        .dark .autocomplete-items div {
            background-color: #3d3d3d;
            border-color: #555;
            color: #f1f1f1;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9; 
        }
        .dark .autocomplete-items div:hover {
            background-color: #4d4d4d; 
        }
        .autocomplete-active {
            background-color: #5D5CDE !important; 
            color: #ffffff; 
        }
        
        /* Compass styles */
        .compass {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }
        .compass-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #ccc;
        }
        .dark .compass-face {
            background-color: #3d3d3d;
            border-color: #555;
        }
        .compass-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 40%;
            background-color: #5D5CDE;
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
        }
        .compass-direction {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #333;
        }
        .dark .compass-direction {
            color: #fff;
        }
        
        /* Weather settings toggle */
        .toggle-checkbox {
            height: 0;
            width: 0;
            visibility: hidden;
            position: absolute;
        }
        .toggle-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            width: 50px;
            height: 25px;
            background: grey;
            border-radius: 100px;
            position: relative;
            transition: background-color 0.2s;
        }
        .toggle-label .toggle-button {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            border-radius: 45px;
            transition: 0.2s;
            background: #fff;
            box-shadow: 0 0 2px 0 rgba(10, 10, 10, 0.29);
        }
        .toggle-checkbox:checked + .toggle-label {
            background: #5D5CDE;
        }
        .toggle-checkbox:checked + .toggle-label .toggle-button {
            left: calc(100% - 2px);
            transform: translateX(-100%);
        }
        
        /* Pulse animation for alerts */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse-alert {
            animation: pulse 2s infinite;
        }
        
        /* Favorite button animation */
        @keyframes favorite-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .favorite-animation {
            animation: favorite-animation 0.3s;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div class="container mx-auto px-4 py-6 max-w-xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">SkySense</h1>
            
            <!-- Unit Toggle -->
            <div class="flex items-center gap-2">
                <span class="text-gray-700 dark:text-gray-300">°C</span>
                <div class="relative inline-block">
                    <input type="checkbox" id="unit-toggle" class="toggle-checkbox" />
                    <label for="unit-toggle" class="toggle-label">
                        <span class="toggle-button"></span>
                    </label>
                </div>
                <span class="text-gray-700 dark:text-gray-300">°F</span>
                
                <!-- Settings Button -->
                <button id="settings-button" class="ml-2 p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
                    <i class="ti ti-settings text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Top Banner Ad -->
        <div class="ad-container horizontal">
            <span class="ad-label">Advertisement</span>
            <div id="top-banner-ad">
                <div class="bg-gray-200 dark:bg-gray-700 w-full h-16 flex items-center justify-center">
                    <span class="text-gray-500 dark:text-gray-400">728×90 Ad Banner</span>
                </div>
            </div>
        </div>
        
        <!-- Alerts Container -->
        <div id="alerts-container" class="hidden bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 rounded-lg mb-4 pulse-alert">
            <div class="flex items-start">
                <i class="ti ti-alert-triangle text-yellow-600 dark:text-yellow-400 text-xl mr-2 mt-0.5"></i>
                <div>
                    <h3 class="font-semibold text-yellow-800 dark:text-yellow-300" id="alert-title">Weather Alert</h3>
                    <p class="text-yellow-700 dark:text-yellow-200 text-sm" id="alert-message"></p>
                </div>
            </div>
        </div>
        
        <!-- Favorites Bar -->
        <div id="favorites-container" class="hidden mb-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Favorite Locations</h3>
                    <button id="manage-favorites" class="text-xs text-primary hover:underline">Manage</button>
                </div>
                <div id="favorites-list" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
            <div class="flex border-b dark:border-gray-700">
                <button id="searchTab" class="location-tab flex-1 py-3 text-center text-gray-800 dark:text-white font-medium active">
                    Search Location
                </button>
                <button id="mapTab" class="location-tab flex-1 py-3 text-center text-gray-800 dark:text-white font-medium">
                    Pin on Map
                </button>
            </div>
            
            <div id="searchPanel" class="p-6">
                <div id="autocompleteContainer" class="relative">
                    <form id="weatherForm" class="flex flex-col md:flex-row gap-2">
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                id="locationInput" 
                                placeholder="City, mountain, desert, sea coordinates..." 
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
                                autocomplete="off"
                                required
                                value="New York"
                            >
                            <div class="autocomplete-items hidden" id="autocomplete-list"></div>
                        </div>
                        <button 
                            type="submit" 
                            class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                        >
                            <i class="ti ti-search mr-1"></i> Search
                        </button>
                    </form>
                </div>
            </div>
            
            <div id="mapPanel" class="hidden p-4">
                <div id="map" class="mb-4"></div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    Click anywhere on the map to get weather for that exact location (mountains, deserts, seas, etc.).
                </p>
                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <span class="text-gray-700 dark:text-gray-300">Selected point:</span>
                    <span id="selectedLocation" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-full text-sm text-gray-800 dark:text-white">None selected</span>
                </div>
                <button 
                    id="getWeatherForLocation" 
                    class="w-full px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50"
                    disabled
                >
                    Get Weather
                </button>
            </div>
        </div>
        
        <div id="loadingContainer" class="flex justify-center items-center py-10">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-700 dark:text-gray-300" id="loadingText">Loading weather data...</p>
            </div>
        </div>

        <div id="weatherContainer" class="hidden">
            <!-- Current Weather Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-4">
                <div class="flex justify-between items-start px-4 pt-4">
                    <h2 id="locationName" class="text-2xl font-bold text-gray-800 dark:text-white"></h2>
                    <div class="flex items-center gap-2">
                        <button id="share-button" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
                            <i class="ti ti-share text-xl"></i>
                        </button>
                        <button id="favorite-button" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
                            <i class="ti ti-star text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div id="weatherHeader" class="p-6 flex flex-col md:flex-row items-center gap-4">
                    <div id="weatherIconContainer" class="flex-shrink-0 weather-icon"></div>
                    <div class="flex-1">
                        <p id="weatherDescription" class="text-gray-600 dark:text-gray-300 mb-3 text-center md:text-left"></p>
                        <div class="flex flex-wrap gap-x-6 gap-y-2">
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium">Temperature:</span>
                                <span id="temperature" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium">Feels like:</span>
                                <span id="feelsLike" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium">Humidity:</span>
                                <span id="humidity" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium">Wind:</span>
                                <span id="wind" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expandable Weather Details -->
                <div class="px-6 pb-4">
                    <button id="details-toggle" class="w-full flex justify-between items-center text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary focus:outline-none transition-colors">
                        <span class="font-medium">Weather Details</span>
                        <i class="ti ti-chevron-down transition-transform duration-200"></i>
                    </button>
                    
                    <div id="details-content" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400">UV Index</p>
                                <p id="uv-index" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Precipitation</p>
                                <p id="precipitation" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Sunrise</p>
                                <p id="sunrise" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Sunset</p>
                                <p id="sunset" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center">Wind Direction</p>
                                <div id="wind-compass" class="compass">
                                    <div class="compass-face">
                                        <div class="compass-direction">N</div>
                                        <div class="compass-direction" style="transform: rotate(90deg)">E</div>
                                        <div class="compass-direction" style="transform: rotate(180deg)">S</div>
                                        <div class="compass-direction" style="transform: rotate(270deg)">W</div>
                                        <div id="compass-arrow" class="compass-arrow"></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center">Historical Comparison</p>
                                <div id="historical-comparison" class="text-center px-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <p id="historical-text" class="text-sm text-gray-700 dark:text-gray-300">Loading historical data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hourly Forecast -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-4">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">24-Hour Forecast</h3>
                </div>
                <div class="p-4 forecast-container">
                    <div id="hourlyForecastContent" class="flex gap-3 min-w-full"></div>
                </div>
            </div>
            
            <!-- 7-Day Forecast with Temperature Graph -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">7-Day Forecast</h3>
                </div>
                
                <div class="p-4">
                    <div class="mb-4 h-48">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                    
                    <div class="forecast-container pb-2">
                        <div id="forecastContent" class="flex gap-3 min-w-full"></div>
                    </div>
                </div>
            </div>
            
            <!-- Middle Ad (Rectangle) -->
            <div class="ad-container square mx-4">
                <span class="ad-label">Advertisement</span>
                <div id="middle-rectangle-ad">
                    <div class="bg-gray-200 dark:bg-gray-700 w-full h-40 flex items-center justify-center">
                        <span class="text-gray-500 dark:text-gray-400">300×250 Ad Rectangle</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="errorContainer" class="hidden bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-100 p-4 rounded-lg mt-4">
            <p id="errorMessage"></p>
        </div>
        
        <!-- Bottom Banner Ad -->
        <div class="ad-container horizontal mt-6">
            <span class="ad-label">Advertisement</span>
            <div id="bottom-banner-ad">
                <div class="bg-gray-200 dark:bg-gray-700 w-full h-16 flex items-center justify-center">
                    <span class="text-gray-500 dark:text-gray-400">728×90 Ad Banner</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="settings-backdrop"></div>
        <div class="relative max-w-md mx-auto mt-20 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Customize Dashboard</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="ti ti-x text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Select which weather elements to display:</p>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label for="show-hourly" class="text-gray-700 dark:text-gray-300">Hourly Forecast</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-hourly" class="toggle-checkbox" checked />
                            <label for="show-hourly" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-details" class="text-gray-700 dark:text-gray-300">Weather Details</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-details" class="toggle-checkbox" checked />
                            <label for="show-details" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-chart" class="text-gray-700 dark:text-gray-300">Temperature Chart</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-chart" class="toggle-checkbox" checked />
                            <label for="show-chart" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-alerts" class="text-gray-700 dark:text-gray-300">Weather Alerts</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-alerts" class="toggle-checkbox" checked />
                            <label for="show-alerts" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-historical" class="text-gray-700 dark:text-gray-300">Historical Comparison</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-historical" class="toggle-checkbox" checked />
                            <label for="show-historical" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 text-right">
                    <button id="save-settings" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        Save Preferences
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="share-backdrop"></div>
        <div class="relative max-w-md mx-auto mt-20 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Share Weather</h3>
                <button id="close-share" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="ti ti-x text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Share this weather information with others:</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Share Link</label>
                    <div class="flex">
                        <input type="text" id="share-url" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-lg text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" readonly>
                        <button id="copy-link" class="px-4 py-2 bg-primary text-white rounded-r-lg hover:bg-opacity-90 transition-colors">
                            <i class="ti ti-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-center gap-4">
                    <a href="#" id="share-twitter" class="p-3 bg-[#1DA1F2] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-twitter text-xl"></i>
                    </a>
                    <a href="#" id="share-facebook" class="p-3 bg-[#1877F2] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-facebook text-xl"></i>
                    </a>
                    <a href="#" id="share-whatsapp" class="p-3 bg-[#25D366] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-whatsapp text-xl"></i>
                    </a>
                    <a href="#" id="share-telegram" class="p-3 bg-[#0088cc] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-telegram text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Favorites Management Modal -->
    <div id="favorites-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="favorites-backdrop"></div>
        <div class="relative max-w-md mx-auto mt-20 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Manage Favorites</h3>
                <button id="close-favorites" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="ti ti-x text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="no-favorites" class="hidden text-center py-6 text-gray-500 dark:text-gray-400">
                    <i class="ti ti-star text-4xl mb-2"></i>
                    <p>No favorite locations yet</p>
                </div>
                
                <ul id="favorites-management-list" class="divide-y divide-gray-200 dark:divide-gray-700"></ul>
                
                <div class="mt-6 text-right">
                    <button id="done-favorites" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Weather code to icon mapping for Open-Meteo
        const weatherIcons = {
            // Clear, Sunny
            0: '☀️', // Clear sky
            1: '🌤️', // Mainly clear
            2: '⛅', // Partly cloudy
            3: '☁️', // Overcast
            
            // Fog, Mist
            45: '🌫️', // Fog
            48: '🌫️', // Depositing rime fog
            
            // Drizzle
            51: '🌧️', // Light drizzle
            53: '🌧️', // Moderate drizzle
            55: '🌧️', // Dense drizzle
            
            // Freezing Drizzle
            56: '🌧️', // Light freezing drizzle
            57: '🌧️', // Dense freezing drizzle
            
            // Rain
            61: '🌧️', // Slight rain
            63: '🌧️', // Moderate rain
            65: '🌧️', // Heavy rain
            
            // Freezing Rain
            66: '🌨️', // Light freezing rain
            67: '🌨️', // Heavy freezing rain
            
            // Snow
            71: '❄️', // Slight snow fall
            73: '❄️', // Moderate snow fall
            75: '❄️', // Heavy snow fall
            
            // Snow Grains
            77: '❄️', // Snow grains
            
            // Rain Showers
            80: '🌦️', // Slight rain showers
            81: '🌦️', // Moderate rain showers
            82: '🌦️', // Violent rain showers
            
            // Snow Showers
            85: '🌨️', // Slight snow showers
            86: '🌨️', // Heavy snow showers
            
            // Thunderstorm
            95: '⛈️', // Thunderstorm
            96: '⛈️', // Thunderstorm with slight hail
            99: '⛈️', // Thunderstorm with heavy hail
            
            // Default
            undefined: '🌡️'
        };

        // WMO Weather interpretation codes to text descriptions
        const weatherDescriptions = {
            0: "Clear sky",
            1: "Mainly clear",
            2: "Partly cloudy",
            3: "Overcast",
            45: "Fog",
            48: "Depositing rime fog",
            51: "Light drizzle",
            53: "Moderate drizzle",
            55: "Dense drizzle",
            56: "Light freezing drizzle",
            57: "Dense freezing drizzle",
            61: "Slight rain",
            63: "Moderate rain",
            65: "Heavy rain",
            66: "Light freezing rain",
            67: "Heavy freezing rain",
            71: "Slight snow fall",
            73: "Moderate snow fall",
            75: "Heavy snow fall",
            77: "Snow grains",
            80: "Slight rain showers",
            81: "Moderate rain showers",
            82: "Violent rain showers",
            85: "Slight snow showers",
            86: "Heavy snow showers",
            95: "Thunderstorm",
            96: "Thunderstorm with slight hail",
            99: "Thunderstorm with heavy hail",
            undefined: "Unknown"
        };

        // Map WMO Weather codes to alert levels
        const weatherAlertLevels = {
            // No alerts
            0: 0, 1: 0, 2: 0, 3: 0, 45: 0, 48: 0, 
            // Light alerts
            51: 1, 53: 1, 56: 1, 61: 1, 71: 1, 80: 1, 85: 1,
            // Moderate alerts
            55: 2, 57: 2, 63: 2, 66: 2, 73: 2, 81: 2, 86: 2,
            // Severe alerts
            65: 3, 67: 3, 75: 3, 77: 3, 82: 3, 95: 3, 96: 3, 99: 3
        };

        // DOM Elements
        const weatherForm = document.getElementById('weatherForm');
        const locationInput = document.getElementById('locationInput');
        const weatherContainer = document.getElementById('weatherContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingText = document.getElementById('loadingText');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const locationName = document.getElementById('locationName');
        const weatherDescription = document.getElementById('weatherDescription');
        const weatherIconContainer = document.getElementById('weatherIconContainer');
        const temperature = document.getElementById('temperature');
        const feelsLike = document.getElementById('feelsLike');
        const humidity = document.getElementById('humidity');
        const wind = document.getElementById('wind');
        const forecastContent = document.getElementById('forecastContent');
        const hourlyForecastContent = document.getElementById('hourlyForecastContent');
        const searchTab = document.getElementById('searchTab');
        const mapTab = document.getElementById('mapTab');
        const searchPanel = document.getElementById('searchPanel');
        const mapPanel = document.getElementById('mapPanel');
        const selectedLocation = document.getElementById('selectedLocation');
        const getWeatherForLocation = document.getElementById('getWeatherForLocation');
        const unitToggle = document.getElementById('unit-toggle');
        const alertsContainer = document.getElementById('alerts-container');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const detailsToggle = document.getElementById('details-toggle');
        const detailsContent = document.getElementById('details-content');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsBackdrop = document.getElementById('settings-backdrop');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');
        const shareButton = document.getElementById('share-button');
        const shareModal = document.getElementById('share-modal');
        const shareBackdrop = document.getElementById('share-backdrop');
        const closeShare = document.getElementById('close-share');
        const shareUrl = document.getElementById('share-url');
        const copyLink = document.getElementById('copy-link');
        const shareTwitter = document.getElementById('share-twitter');
        const shareFacebook = document.getElementById('share-facebook');
        const shareWhatsapp = document.getElementById('share-whatsapp');
        const shareTelegram = document.getElementById('share-telegram');
        const favoriteButton = document.getElementById('favorite-button');
        const favoritesContainer = document.getElementById('favorites-container');
        const favoritesList = document.getElementById('favorites-list');
        const manageFavorites = document.getElementById('manage-favorites');
        const favoritesModal = document.getElementById('favorites-modal');
        const favoritesBackdrop = document.getElementById('favorites-backdrop');
        const closeFavorites = document.getElementById('close-favorites');
        const doneFavorites = document.getElementById('done-favorites');
        const favoritesManagementList = document.getElementById('favorites-management-list');
        const noFavorites = document.getElementById('no-favorites');
        const autocompleteList = document.getElementById('autocomplete-list');
        
        // Settings elements
        const showHourly = document.getElementById('show-hourly');
        const showDetails = document.getElementById('show-details');
        const showChart = document.getElementById('show-chart');
        const showAlerts = document.getElementById('show-alerts');
        const showHistorical = document.getElementById('show-historical');
        
        // Chart object
        let temperatureChart = null;
        
        // Map variables
        let map = null;
        let marker = null;
        let selectedCoords = null;
        
        // Current location data
        let currentLocationData = null;
        let currentWeatherData = null;
        
        // Unit preference (default: metric)
        let useMetric = true;
        
        // User preferences
        const userPreferences = {
            showHourly: true,
            showDetails: true,
            showChart: true,
            showAlerts: true,
            showHistorical: true,
            useMetric: true,
            favorites: []
        };
        
        // Initialize application
        function initApp() {
            console.log("Initializing app...");
            
            // Load user preferences
            loadUserPreferences();
            
            // Set up event listeners
            setupEventListeners();
            
            // Apply preferences to UI
            applyUserPreferences();
            
            // Initialize with default city
            getWeatherByLocationName("New York");
        }
        
        // Load user preferences from sessionStorage
        function loadUserPreferences() {
            try {
                const savedPreferences = window.sessionStorage.getItem('skyweatherPrefs');
                if (savedPreferences) {
                    const parsedPrefs = JSON.parse(savedPreferences);
                    Object.assign(userPreferences, parsedPrefs);
                    useMetric = userPreferences.useMetric;
                }
            } catch (err) {
                console.error("Error loading preferences:", err);
                // If there's an error, we'll just use the defaults
            }
        }
        
        // Save user preferences to sessionStorage
        function saveUserPreferences() {
            try {
                userPreferences.useMetric = useMetric;
                window.sessionStorage.setItem('skyweatherPrefs', JSON.stringify(userPreferences));
            } catch (err) {
                console.error("Error saving preferences:", err);
                // Non-critical error, so we'll just log it
            }
        }
        
        // Apply user preferences to UI
        function applyUserPreferences() {
            // Apply unit toggle state
            unitToggle.checked = !userPreferences.useMetric;
            
            // Apply settings toggle states
            showHourly.checked = userPreferences.showHourly;
            showDetails.checked = userPreferences.showDetails;
            showChart.checked = userPreferences.showChart;
            showAlerts.checked = userPreferences.showAlerts;
            showHistorical.checked = userPreferences.showHistorical;
            
            // Load favorites
            if (userPreferences.favorites && userPreferences.favorites.length > 0) {
                renderFavorites();
                favoritesContainer.classList.remove('hidden');
            }
            
            // If weather data is loaded, update the display with the current unit preference
            if (currentWeatherData && currentLocationData) {
                displayWeatherData(currentWeatherData, currentLocationData.displayName);
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // Weather form submission
            weatherForm.addEventListener('submit', handleWeatherFormSubmit);
            
            // Map location weather button
            getWeatherForLocation.addEventListener('click', handleGetWeatherForLocation);
            
            // Tab switching
            searchTab.addEventListener('click', () => switchTab('search'));
            mapTab.addEventListener('click', () => switchTab('map'));
            
            // Unit toggle
            unitToggle.addEventListener('change', handleUnitToggle);
            
            // Details toggle
            detailsToggle.addEventListener('click', toggleDetails);
            
            // Settings modal
            settingsButton.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            if (settingsBackdrop) {
                settingsBackdrop.addEventListener('click', () => settingsModal.classList.add('hidden'));
            }
            closeSettings.addEventListener('click', () => settingsModal.classList.add('hidden'));
            saveSettings.addEventListener('click', handleSaveSettings);
            
            // Share modal
            shareButton.addEventListener('click', openShareModal);
            if (shareBackdrop) {
                shareBackdrop.addEventListener('click', () => shareModal.classList.add('hidden'));
            }
            closeShare.addEventListener('click', () => shareModal.classList.add('hidden'));
            copyLink.addEventListener('click', copyShareLink);
            
            // Favorite button
            favoriteButton.addEventListener('click', toggleFavorite);
            
            // Favorites management
            if (manageFavorites) {
                manageFavorites.addEventListener('click', openFavoritesModal);
            }
            if (favoritesBackdrop) {
                favoritesBackdrop.addEventListener('click', () => favoritesModal.classList.add('hidden'));
            }
            if (closeFavorites) {
                closeFavorites.addEventListener('click', () => favoritesModal.classList.add('hidden'));
            }
            if (doneFavorites) {
                doneFavorites.addEventListener('click', () => favoritesModal.classList.add('hidden'));
            }
            
            // Location input for autocomplete
            locationInput.addEventListener('input', handleLocationInput);
            locationInput.addEventListener('keydown', handleAutocompleteKeydown);
            document.addEventListener('click', () => {
                if (autocompleteList) {
                    autocompleteList.classList.add('hidden');
                }
            });
        }
        
        // Handle weather form submission
        async function handleWeatherFormSubmit(e) {
            e.preventDefault();
            const location = locationInput.value.trim();
            
            if (!location) {
                showError("Please enter a location");
                return;
            }
            
            await getWeatherByLocationName(location);
        }
        
        // Handle get weather for map location
        function handleGetWeatherForLocation() {
            if (selectedCoords) {
                const { lat, lng } = selectedCoords;
                const displayName = `${lat.toFixed(4)}°, ${lng.toFixed(4)}°`;
                getWeatherByCoordinates(lat, lng, displayName);
            }
        }
        
        // Switch between search and map tabs
        function switchTab(tab) {
            if (tab === 'search') {
                searchTab.classList.add('active');
                mapTab.classList.remove('active');
                searchPanel.classList.remove('hidden');
                mapPanel.classList.add('hidden');
            } else {
                mapTab.classList.add('active');
                searchTab.classList.remove('active');
                mapPanel.classList.remove('hidden');
                searchPanel.classList.add('hidden');
                
                // Initialize map if not already done
                if (!map) {
                    initMapOnFirstClick();
                } else {
                    // Refresh map size after tab change
                    setTimeout(() => {
                        if (map) map.invalidateSize();
                    }, 100);
                }
            }
        }
        
        // Handle unit toggle
        function handleUnitToggle() {
            useMetric = !unitToggle.checked;
            userPreferences.useMetric = useMetric;
            saveUserPreferences();
            
            // Update displayed weather data with new unit
            if (currentWeatherData && currentLocationData) {
                displayWeatherData(currentWeatherData, currentLocationData.displayName);
            }
        }
        
        // Toggle weather details section
        function toggleDetails() {
            const icon = detailsToggle.querySelector('i');
            if (detailsContent.classList.contains('hidden')) {
                detailsContent.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                detailsContent.classList.add('hidden');
                icon.style.transform = 'rotate(0)';
            }
        }
        
        // Save settings preferences
        function handleSaveSettings() {
            userPreferences.showHourly = showHourly.checked;
            userPreferences.showDetails = showDetails.checked;
            userPreferences.showChart = showChart.checked;
            userPreferences.showAlerts = showAlerts.checked;
            userPreferences.showHistorical = showHistorical.checked;
            
            saveUserPreferences();
            settingsModal.classList.add('hidden');
            
            // Update UI based on new preferences
            updateUIBasedOnPreferences();
        }
        
        // Update UI based on current preferences
        function updateUIBasedOnPreferences() {
            const hourlyForecastSection = hourlyForecastContent.closest('.bg-white');
            hourlyForecastSection.style.display = userPreferences.showHourly ? 'block' : 'none';
            
            // If details are shown and preference is to hide them, hide the content
            if (!userPreferences.showDetails && !detailsContent.classList.contains('hidden')) {
                toggleDetails();
            }
            
            // If chart preference is to hide, hide the chart section
            const chartSection = document.getElementById('temperatureChart').closest('div');
            chartSection.style.display = userPreferences.showChart ? 'block' : 'none';
            
            // Apply alert preference (only affects future alerts, doesn't hide current ones)
            // Current alerts will be updated next time weather data is fetched
        }
        
        // Initialize map on first click of map tab
        function initMapOnFirstClick() {
            console.log("Initializing map...");
            
            try {
                if (!L) {
                    console.error("Leaflet library not loaded.");
                    return;
                }
                
                map = L.map('map').setView([40.7128, -74.0060], 10); // Default to NYC
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Add click handler
                map.on('click', function(e) {
                    const { lat, lng } = e.latlng;
                    selectedCoords = { lat, lng };
                    
                    // Update or add marker
                    if (marker) {
                        marker.setLatLng(e.latlng);
                    } else {
                        marker = L.marker(e.latlng).addTo(map);
                    }
                    
                    // Update UI
                    selectedLocation.textContent = `${lat.toFixed(4)}°, ${lng.toFixed(4)}°`;
                    getWeatherForLocation.disabled = false;
                });
                
                // If we have user coordinates, center the map there
                if (window.userCoordinates) {
                    const { latitude, longitude } = window.userCoordinates;
                    map.setView([latitude, longitude], 10);
                    
                    // Add a marker for user's location
                    L.marker([latitude, longitude])
                        .addTo(map)
                        .bindPopup('Your Location')
                        .openPopup();
                } else if (currentLocationData && currentLocationData.latitude && currentLocationData.longitude) {
                    // Use current weather location if available
                    map.setView([currentLocationData.latitude, currentLocationData.longitude], 10);
                    marker = L.marker([currentLocationData.latitude, currentLocationData.longitude]).addTo(map);
                }
                
                // Refresh map on tab change (fixes rendering issues)
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
                
            } catch (error) {
                console.error("Error initializing map:", error);
                const mapErrorMessage = document.createElement('div');
                mapErrorMessage.innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        <p>Could not initialize map. Please try refreshing the page.</p>
                    </div>
                `;
                document.getElementById('map').appendChild(mapErrorMessage);
            }
        }
        
        // Format temperature with units
        function formatTemperature(temp) {
            if (!useMetric) {
                // Convert to Fahrenheit
                temp = (temp * 9/5) + 32;
            }
            return `${Math.round(temp)}°${useMetric ? 'C' : 'F'}`;
        }
        
        // Format date string from ISO date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }
        
        // Format time from ISO date or hour string
        function formatTime(timeString) {
            let date;
            if (timeString.includes('T')) {
                // Full ISO date
                date = new Date(timeString);
            } else if (timeString.length === 2) {
                // Hour string (e.g., "09")
                date = new Date();
                date.setHours(parseInt(timeString, 10), 0, 0);
            } else {
                return timeString;
            }
            
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Convert wind speed and direction to human-readable format
        function formatWind(speed, direction) {
            let formattedSpeed;
            
            if (useMetric) {
                // Converting m/s to km/h
                formattedSpeed = `${Math.round(speed * 3.6)} km/h`;
            } else {
                // Converting m/s to mph
                formattedSpeed = `${Math.round(speed * 2.237)} mph`;
            }
            
            // Get cardinal direction
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(direction / 45) % 8;
            
            return `${formattedSpeed} ${directions[index]}`;
        }
        
        // Create temperature chart
        function createTemperatureChart(dailyData) {
            if (!userPreferences.showChart) return;
            
            try {
                const ctx = document.getElementById('temperatureChart').getContext('2d');
                
                // Prepare data
                const labels = dailyData.time.map(formatDate);
                const maxTemps = dailyData.temperature_2m_max.map(temp => useMetric ? temp : (temp * 9/5) + 32);
                const minTemps = dailyData.temperature_2m_min.map(temp => useMetric ? temp : (temp * 9/5) + 32);
                
                // Destroy previous chart if it exists
                if (temperatureChart) {
                    temperatureChart.destroy();
                }
                
                // Create new chart
                temperatureChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Max Temp',
                                data: maxTemps,
                                borderColor: '#FF6B6B',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                fill: false,
                                tension: 0.4,
                                pointBackgroundColor: '#FF6B6B',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Min Temp',
                                data: minTemps,
                                borderColor: '#4ECDC4',
                                backgroundColor: 'rgba(78, 205, 196, 0.1)',
                                fill: false,
                                tension: 0.4,
                                pointBackgroundColor: '#4ECDC4',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#f1f1f1' : '#333'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#f1f1f1' : '#333',
                                    callback: function(value) {
                                        return value + '°' + (useMetric ? 'C' : 'F');
                                    }
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#f1f1f1' : '#333'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creating temperature chart:", error);
            }
        }
        
        // Handle location autocomplete
        let autocompleteTimeout;
        async function handleLocationInput() {
            const query = locationInput.value.trim();
            
            if (query.length < 2) {
                autocompleteList.classList.add('hidden');
                return;
            }
            
            // Clear previous timeout to avoid rapid API calls
            clearTimeout(autocompleteTimeout);
            
            // Set a timeout to allow user to finish typing
            autocompleteTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5`);
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        autocompleteList.classList.add('hidden');
                        return;
                    }
                    
                    // Display results
                    renderAutocompleteResults(data.results);
                } catch (err) {
                    console.error("Autocomplete error:", err);
                    autocompleteList.classList.add('hidden');
                }
            }, 300);
        }
        
        // Render autocomplete results
        function renderAutocompleteResults(results) {
            autocompleteList.innerHTML = '';
            
            results.forEach(location => {
                const div = document.createElement('div');
                div.textContent = `${location.name}, ${location.country}${location.admin1 ? ` (${location.admin1})` : ''}`;
                div.addEventListener('click', () => {
                    locationInput.value = `${location.name}, ${location.country}`;
                    autocompleteList.classList.add('hidden');
                    weatherForm.dispatchEvent(new Event('submit'));
                });
                autocompleteList.appendChild(div);
            });
            
            autocompleteList.classList.remove('hidden');
        }
        
        // Handle keyboard navigation in autocomplete
        function handleAutocompleteKeydown(e) {
            if (autocompleteList.classList.contains('hidden')) return;
            
            const items = autocompleteList.querySelectorAll('div');
            let activeItem = autocompleteList.querySelector('.autocomplete-active');
            let activeIndex = Array.from(items).indexOf(activeItem);
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (activeItem) activeItem.classList.remove('autocomplete-active');
                    activeIndex = Math.min(activeIndex + 1, items.length - 1);
                    items[activeIndex].classList.add('autocomplete-active');
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (activeItem) activeItem.classList.remove('autocomplete-active');
                    activeIndex = Math.max(activeIndex - 1, 0);
                    if (activeIndex >= 0) items[activeIndex].classList.add('autocomplete-active');
                    break;
                case 'Enter':
                    if (activeItem) {
                        e.preventDefault();
                        activeItem.click();
                    }
                    break;
                case 'Escape':
                    autocompleteList.classList.add('hidden');
                    break;
            }
        }
        
        // Update wind direction compass
        function updateWindCompass(direction) {
            const arrow = document.getElementById('compass-arrow');
            if (arrow) {
                arrow.style.transform = `translate(-50%, -100%) rotate(${direction}deg)`;
            }
        }
        
        // Check weather conditions for alerts
        function checkWeatherAlerts(data) {
            if (!userPreferences.showAlerts) {
                alertsContainer.classList.add('hidden');
                return;
            }
            
            // Check current weather code for severe conditions
            const currentWeatherCode = data.current.weather_code;
            const alertLevel = weatherAlertLevels[currentWeatherCode] || 0;
            
            // Check if precipitation is high
            const hasPrecipitation = (data.daily && data.daily.precipitation_sum && 
                                     data.daily.precipitation_sum[0] > 20); // More than 20mm is significant
            
            // Check wind speed for high winds
            const highWinds = data.current.wind_speed_10m > 15; // More than 15 m/s is significant
            
            if (alertLevel >= 2 || hasPrecipitation || highWinds) {
                // Create alert message
                let alertText = weatherDescriptions[currentWeatherCode];
                
                if (hasPrecipitation) {
                    alertText += ` | Heavy precipitation expected (${data.daily.precipitation_sum[0]}mm)`;
                }
                
                if (highWinds) {
                    alertText += ` | Strong winds (${formatWind(data.current.wind_speed_10m, data.current.wind_direction_10m)})`;
                }
                
                // Display alert
                alertTitle.textContent = "Weather Alert";
                alertMessage.textContent = alertText;
                alertsContainer.classList.remove('hidden');
            } else {
                alertsContainer.classList.add('hidden');
            }
        }
        
        // Open share modal
        function openShareModal() {
            if (!currentLocationData) return;
            
            // Create share URL
            let shareUrlText = window.location.href.split('?')[0];
            
            if (currentLocationData.latitude && currentLocationData.longitude) {
                shareUrlText += `?lat=${currentLocationData.latitude}&lon=${currentLocationData.longitude}`;
            } else if (currentLocationData.name) {
                shareUrlText += `?loc=${encodeURIComponent(currentLocationData.name)}`;
            }
            
            shareUrl.value = shareUrlText;
            
            // Set up social sharing links
            const weatherText = encodeURIComponent(`Check out the weather in ${currentLocationData.displayName}: ${weatherDescriptions[currentWeatherData.current.weather_code]}, ${temperature.textContent}`);
            
            shareTwitter.href = `https://twitter.com/intent/tweet?text=${weatherText}&url=${encodeURIComponent(shareUrlText)}`;
            shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrlText)}`;
            shareWhatsapp.href = `https://wa.me/?text=${weatherText} ${encodeURIComponent(shareUrlText)}`;
            shareTelegram.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrlText)}&text=${weatherText}`;
            
            // Show modal
            shareModal.classList.remove('hidden');
        }
        
        // Copy share link to clipboard
        function copyShareLink() {
            shareUrl.select();
            
            try {
                navigator.clipboard.writeText(shareUrl.value);
                copyLink.innerHTML = '<i class="ti ti-check"></i>';
                setTimeout(() => {
                    copyLink.innerHTML = '<i class="ti ti-copy"></i>';
                }, 2000);
            } catch (err) {
                console.error("Clipboard error:", err);
                // Fallback using document.execCommand
                document.execCommand('copy');
                copyLink.innerHTML = '<i class="ti ti-check"></i>';
                setTimeout(() => {
                    copyLink.innerHTML = '<i class="ti ti-copy"></i>';
                }, 2000);
            }
        }
        
        // Toggle favorite status of current location
        function toggleFavorite() {
            if (!currentLocationData) return;
            
            const favoriteIcon = favoriteButton.querySelector('i');
            const isFavorite = favoriteIcon.classList.contains('text-yellow-500');
            
            if (isFavorite) {
                // Remove from favorites
                favoriteIcon.classList.remove('text-yellow-500');
                
                // Update favorites list
                userPreferences.favorites = userPreferences.favorites.filter(fav => 
                    !(fav.latitude === currentLocationData.latitude && 
                      fav.longitude === currentLocationData.longitude)
                );
            } else {
                // Add to favorites with animation
                favoriteIcon.classList.add('text-yellow-500', 'favorite-animation');
                setTimeout(() => favoriteIcon.classList.remove('favorite-animation'), 300);
                
                // Add to favorites list
                const favorite = {
                    displayName: currentLocationData.displayName,
                    name: currentLocationData.name,
                    latitude: currentLocationData.latitude,
                    longitude: currentLocationData.longitude,
                    country: currentLocationData.country
                };
                
                // Check if already exists
                const exists = userPreferences.favorites.some(fav => 
                    fav.latitude === favorite.latitude && fav.longitude === favorite.longitude
                );
                
                if (!exists) {
                    userPreferences.favorites.push(favorite);
                }
            }
            
            // Save preferences
            saveUserPreferences();
            
            // Update favorites UI
            renderFavorites();
            
            // Show favorites container if there are favorites
            if (userPreferences.favorites.length > 0) {
                favoritesContainer.classList.remove('hidden');
            } else {
                favoritesContainer.classList.add('hidden');
            }
        }
        
        // Render favorites list
        function renderFavorites() {
            favoritesList.innerHTML = '';
            
            // Create favorite buttons
            userPreferences.favorites.forEach(favorite => {
                const button = document.createElement('button');
                button.className = 'px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full text-sm text-gray-800 dark:text-white transition-colors';
                button.textContent = favorite.displayName;
                button.addEventListener('click', () => {
                    getWeatherByCoordinates(favorite.latitude, favorite.longitude, favorite.displayName);
                });
                favoritesList.appendChild(button);
            });
        }
        
        // Open favorites management modal
        function openFavoritesModal() {
            favoritesManagementList.innerHTML = '';
            
            if (userPreferences.favorites.length === 0) {
                noFavorites.classList.remove('hidden');
            } else {
                noFavorites.classList.add('hidden');
                
                // Create list items for each favorite
                userPreferences.favorites.forEach((favorite, index) => {
                    const li = document.createElement('li');
                    li.className = 'py-3 flex justify-between items-center';
                    li.innerHTML = `
                        <span class="text-gray-800 dark:text-white">${favorite.displayName}</span>
                        <button class="text-red-500 hover:text-red-700 dark:hover:text-red-400" data-index="${index}">
                            <i class="ti ti-trash text-xl"></i>
                        </button>
                    `;
                    
                    // Add delete handler
                    const deleteButton = li.querySelector('button');
                    deleteButton.addEventListener('click', () => {
                        userPreferences.favorites.splice(index, 1);
                        saveUserPreferences();
                        li.remove();
                        
                        // Update favorites UI
                        renderFavorites();
                        
                        // Check if favorites is now empty
                        if (userPreferences.favorites.length === 0) {
                            noFavorites.classList.remove('hidden');
                            favoritesContainer.classList.add('hidden');
                        }
                    });
                    
                    favoritesManagementList.appendChild(li);
                });
            }
            
            favoritesModal.classList.remove('hidden');
        }
        
        // Display weather data on the page
        function displayWeatherData(data, locationNameStr) {
            try {
                console.log("Displaying weather data for:", locationNameStr);
                
                // Save weather data for reference
                currentWeatherData = data;
                
                // Current weather data
                const current = {
                    temperature: formatTemperature(data.current.temperature_2m),
                    feelsLike: formatTemperature(data.current.apparent_temperature || data.current.temperature_2m),
                    weatherCode: data.current.weather_code,
                    humidity: `${data.current.relative_humidity_2m}%`,
                    windSpeed: data.current.wind_speed_10m,
                    windDirection: data.current.wind_direction_10m,
                    uvIndex: data.current.uv_index || "N/A"
                };
                
                // Check if location is in favorites
                const isFavorite = userPreferences.favorites.some(fav => 
                    fav.latitude === currentLocationData.latitude && 
                    fav.longitude === currentLocationData.longitude
                );
                
                const favoriteIcon = favoriteButton.querySelector('i');
                if (isFavorite) {
                    favoriteIcon.classList.add('text-yellow-500');
                } else {
                    favoriteIcon.classList.remove('text-yellow-500');
                }
                
                // Display current weather
                locationName.textContent = locationNameStr;
                weatherDescription.textContent = weatherDescriptions[current.weatherCode];
                weatherIconContainer.textContent = weatherIcons[current.weatherCode];
                temperature.textContent = current.temperature;
                feelsLike.textContent = current.feelsLike;
                humidity.textContent = current.humidity;
                wind.textContent = formatWind(current.windSpeed, current.windDirection);
                
                // Update weather details
                if (data.current.uv_index !== undefined) {
                    document.getElementById('uv-index').textContent = data.current.uv_index.toFixed(1);
                }
                if (data.daily && data.daily.precipitation_sum) {
                    document.getElementById('precipitation').textContent = `${data.daily.precipitation_sum[0]} mm`;
                }
                if (data.daily && data.daily.sunrise && data.daily.sunset) {
                    document.getElementById('sunrise').textContent = formatTime(data.daily.sunrise[0]);
                    document.getElementById('sunset').textContent = formatTime(data.daily.sunset[0]);
                }
                
                // Update wind compass
                updateWindCompass(current.windDirection);
                
                // Check for weather alerts
                checkWeatherAlerts(data);
                
                // Display historical comparison (simulated)
                const historicalTemps = [
                    data.current.temperature_2m - 2 + Math.random() * 4,
                    data.current.temperature_2m - 3 + Math.random() * 6,
                    data.current.temperature_2m - 5 + Math.random() * 10
                ];
                const avgHistorical = historicalTemps.reduce((a, b) => a + b, 0) / historicalTemps.length;
                const diff = data.current.temperature_2m - avgHistorical;
                const absDiff = Math.abs(diff);
                
                let comparisonText;
                if (absDiff < 2) {
                    comparisonText = `Current temperature is about average for this time of year.`;
                } else if (diff > 0) {
                    comparisonText = `${formatTemperature(absDiff)} warmer than the historical average for this time.`;
                } else {
                    comparisonText = `${formatTemperature(absDiff)} cooler than the historical average for this time.`;
                }
                
                document.getElementById('historical-text').textContent = comparisonText;
                
                // Display hourly forecast (next 24 hours)
                hourlyForecastContent.innerHTML = '';
                
                if (data.hourly && data.hourly.time) {
                    // Get current hour index
                    const now = new Date();
                    const currentHourIndex = data.hourly.time.findIndex(time => {
                        const timeDate = new Date(time);
                        return timeDate > now;
                    }) - 1;
                    
                    // Display next 24 hours
                    const startIndex = Math.max(0, currentHourIndex);
                    const endIndex = Math.min(startIndex + 24, data.hourly.time.length);
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        const hourData = {
                            time: formatTime(data.hourly.time[i]),
                            temp: formatTemperature(data.hourly.temperature_2m[i]),
                            weatherCode: data.hourly.weather_code?.[i] || 0,
                            precipitation: data.hourly.precipitation_probability?.[i] || 0
                        };
                        
                        const hourElement = document.createElement('div');
                        hourElement.className = 'flex-shrink-0 w-16 bg-gray-50 dark:bg-gray-700 p-2 rounded-lg text-center';
                        hourElement.innerHTML = `
                            <div class="text-xs font-medium text-gray-800 dark:text-white">${hourData.time}</div>
                            <div class="text-xl my-1">${weatherIcons[hourData.weatherCode]}</div>
                            <div class="text-sm text-gray-800 dark:text-white">${hourData.temp}</div>
                            <div class="text-xs text-blue-500 mt-1">${hourData.precipitation}%</div>
                        `;
                        hourlyForecastContent.appendChild(hourElement);
                    }
                }
                
                // Display 7-day forecast
                forecastContent.innerHTML = '';
                
                if (data.daily && data.daily.time) {
                    const forecastDays = Math.min(data.daily.time.length, 7);
                    
                    for (let i = 0; i < forecastDays; i++) {
                        const day = {
                            date: formatDate(data.daily.time[i]),
                            weatherCode: data.daily.weather_code[i],
                            maxTemp: data.daily.temperature_2m_max[i],
                            minTemp: data.daily.temperature_2m_min[i],
                            precipitation: data.daily.precipitation_sum?.[i] || 0
                        };
                        
                        const dayElement = document.createElement('div');
                        dayElement.className = 'flex-shrink-0 w-28 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center';
                        dayElement.innerHTML = `
                            <div class="font-medium text-gray-800 dark:text-white mb-1 truncate">${day.date}</div>
                            <div class="text-2xl mb-1">${weatherIcons[day.weatherCode]}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300 truncate">${weatherDescriptions[day.weatherCode]}</div>
                            <div class="text-sm text-gray-800 dark:text-white mt-1">${formatTemperature(day.maxTemp)} / ${formatTemperature(day.minTemp)}</div>
                            <div class="text-xs text-blue-500 mt-1">${day.precipitation > 0 ? day.precipitation + ' mm' : 'No rain'}</div>
                        `;
                        forecastContent.appendChild(dayElement);
                    }
                }
                
                // Create temperature chart
                if (data.daily && data.daily.time) {
                    createTemperatureChart(data.daily);
                }
                
                // Show the weather container
                weatherContainer.classList.remove('hidden');
                
                // Apply user preferences to UI after displaying weather
                updateUIBasedOnPreferences();
            } catch (err) {
                console.error("Error displaying weather data:", err);
                showError("Failed to display weather data. Please try again.");
            }
        }

        // Show loading indicator
        function showLoading(message = "Loading weather data...") {
            loadingText.textContent = message;
            loadingContainer.classList.remove('hidden');
            weatherContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            loadingContainer.classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            weatherContainer.classList.add('hidden');
            hideLoading();
        }

        // Fetch location coordinates from name using Open-Meteo Geocoding API
        async function getCoordinates(locationName) {
            try {
                console.log("Getting coordinates for:", locationName);
                const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationName)}&count=1`);
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error("Location not found");
                }
                
                const location = data.results[0];
                return {
                    latitude: location.latitude,
                    longitude: location.longitude,
                    name: location.name,
                    country: location.country,
                    displayName: `${location.name}, ${location.country}`
                };
            } catch (err) {
                console.error("Geocoding error:", err);
                throw new Error("Could not find coordinates for this location");
            }
        }

        // Fetch weather data from Open-Meteo API
        async function fetchWeatherData(latitude, longitude) {
            try {
                console.log("Fetching weather data for:", latitude, longitude);
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,uv_index&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset&timezone=auto`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }
                
                return await response.json();
            } catch (err) {
                console.error("Weather API error:", err);
                throw new Error("Could not fetch weather data");
            }
        }

        // Get weather for a location (by name)
        async function getWeatherByLocationName(locationName) {
            showLoading("Finding location...");
            
            try {
                // Get coordinates from location name
                const locationData = await getCoordinates(locationName);
                
                // Save current location data
                currentLocationData = locationData;
                
                showLoading("Getting weather data...");
                
                // Get weather data
                const weatherData = await fetchWeatherData(
                    locationData.latitude, 
                    locationData.longitude
                );
                
                // Display the weather
                displayWeatherData(weatherData, locationData.displayName);
                hideLoading();
                
                // Update map if it exists
                if (map) {
                    map.setView([locationData.latitude, locationData.longitude], 10);
                    
                    if (marker) {
                        marker.setLatLng([locationData.latitude, locationData.longitude]);
                    } else {
                        marker = L.marker([locationData.latitude, locationData.longitude]).addTo(map);
                    }
                }
            } catch (err) {
                showError(err.message);
            }
        }

        // Get weather for coordinates
        async function getWeatherByCoordinates(latitude, longitude, displayName) {
            showLoading("Getting weather data...");
            
            try {
                // Save current location data
                currentLocationData = {
                    latitude,
                    longitude,
                    displayName: displayName || `${latitude.toFixed(2)}°, ${longitude.toFixed(2)}°`
                };
                
                // Get weather data
                const weatherData = await fetchWeatherData(latitude, longitude);
                
                // Display the weather
                displayWeatherData(weatherData, displayName || `${latitude.toFixed(2)}°, ${longitude.toFixed(2)}°`);
                hideLoading();
            } catch (err) {
                showError(err.message);
            }
        }

        // Initialize app when DOM is loaded
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
