<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkySense Weather App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.30.0/tabler-icons.min.css">
    <!-- Yektanet Ad Script -->
    <script>
        !function(e,t,n){e.yektanetAnalyticsObject=n,e[n]=e[n]||function(){e[n].q.push(arguments)},e[n].q=e[n].q||[];var a=t.getElementsByTagName("head")[0],r=new Date,c="https://cdn.yektanet.com/superscript/5TWMQZeM/native-skysenseapp.ir-42143/yn_pub.js?v="+r.getFullYear().toString()+"0"+r.getMonth()+"0"+r.getDate()+"0"+r.getHours(),s=t.createElement("link");s.rel="preload",s.as="script",s.href=c,a.appendChild(s);var l=t.createElement("script");l.async=!0,l.src=c,a.appendChild(l)}(window,document,"yektanet");
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        /* RTL Support */
        [dir="rtl"] .ml-2 {
            margin-right: 0.5rem !important;
            margin-left: 0 !important;
        }
        [dir="rtl"] .mr-2 {
            margin-left: 0.5rem !important;
            margin-right: 0 !important;
        }
        
        .weather-icon {
            font-size: 4rem;
            text-align: center;
        }
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(93, 92, 222, 0.3);
            border-radius: 50%;
            border-top-color: #5D5CDE;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Dark mode styles */
        .dark .weather-card {
            background-color: #2d2d2d;
            color: #f1f1f1;
        }
        .dark .input-field {
            background-color: #3d3d3d;
            color: #ffffff;
        }
        #map { 
            height: 300px; 
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1; /* Ensure proper z-index for map controls */
            position: relative;
        }
        .forecast-container {
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #5D5CDE #f0f0f0;
        }
        .forecast-container::-webkit-scrollbar {
            height: 8px;
        }
        .forecast-container::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }
        .forecast-container::-webkit-scrollbar-thumb {
            background-color: #5D5CDE;
            border-radius: 4px;
        }
        .dark .forecast-container::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        .location-tab {
            position: relative;
            cursor: pointer;
        }
        .location-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #5D5CDE;
        }
        .dark .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }
        .dark .leaflet-container {
            background: #333;
        }
        
        /* Content containers instead of Ad containers to avoid adblockers */
        .content-promotion {
            background-color: #f9f9f9;
            border-radius: 0.5rem;
            margin: 1rem 0;
            padding: 1rem;
            text-align: center;
            overflow: hidden;
        }
        .dark .content-promotion {
            background-color: #2d2d2d;
        }
        .content-promotion.horizontal {
            min-height: 90px;
        }
        .content-promotion.square {
            min-height: 250px;
        }
        .content-label {
            display: block;
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.25rem;
        }
        .dark .content-label {
            color: #aaa;
        }
        
        /* Fixed autocomplete dropdown - with absolute positioning */
        #autocompleteContainer {
            position: relative;
        }
        
        /* IMPORTANT: Fixed search panel height to show dropdown */
        #searchPanel {
            position: relative;
            min-height: 200px; /* Increased to ensure dropdown visibility */
            z-index: 10;
        }
        
        /* Make container non-overflowing for dropdown */
        .search-container {
            overflow: visible !important;
        }
        
        #autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            display: none;
        }
        
        .dark #autocomplete-list {
            background-color: #3d3d3d;
            border-color: #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        
        #autocomplete-list.show {
            display: block !important;
        }
        
        #autocomplete-list div {
            padding: 14px 16px;
            cursor: pointer;
            background-color: white;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        
        .dark #autocomplete-list div {
            background-color: #3d3d3d;
            border-color: #555;
            color: #f1f1f1;
        }
        
        #autocomplete-list div:hover {
            background-color: #f5f5f5;
        }
        
        .dark #autocomplete-list div:hover {
            background-color: #4d4d4d;
        }
        
        .autocomplete-active {
            background-color: #5D5CDE !important;
            color: white !important;
        }
        
        /* Compass styles */
        .compass {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }
        .compass-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #ccc;
        }
        .dark .compass-face {
            background-color: #3d3d3d;
            border-color: #555;
        }
        .compass-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 40%;
            background-color: #5D5CDE;
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
        }
        .compass-direction {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #333;
        }
        .dark .compass-direction {
            color: #fff;
        }
        
        /* Weather settings toggle */
        .toggle-checkbox {
            height: 0;
            width: 0;
            visibility: hidden;
            position: absolute;
        }
        .toggle-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            width: 50px;
            height: 25px;
            background: grey;
            border-radius: 100px;
            position: relative;
            transition: background-color 0.2s;
        }
        .toggle-label .toggle-button {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            border-radius: 45px;
            transition: 0.2s;
            background: #fff;
            box-shadow: 0 0 2px 0 rgba(10, 10, 10, 0.29);
        }
        .toggle-checkbox:checked + .toggle-label {
            background: #5D5CDE;
        }
        .toggle-checkbox:checked + .toggle-label .toggle-button {
            left: calc(100% - 2px);
            transform: translateX(-100%);
        }
        
        /* Pulse animation for alerts */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse-alert {
            animation: pulse 2s infinite;
        }
        
        /* IMPROVED: Weather alerts styling */
        .alert-severity-1 {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }
        .dark .alert-severity-1 {
            background-color: #755e11;
            border-color: #876c15;
            color: #ffe69c;
        }
        
        .alert-severity-2 {
            background-color: #ffeaee;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .dark .alert-severity-2 {
            background-color: #7d282f;
            border-color: #922d35;
            color: #f8d7da;
        }
        
        .alert-severity-3 {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .dark .alert-severity-3 {
            background-color: #6b1a21;
            border-color: #ae2230;
            color: #f5c6cb;
        }
        
        .alert-action-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .alert-dismiss {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            color: inherit;
            opacity: 0.6;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .alert-dismiss:hover {
            opacity: 1;
        }
        
        /* Favorite button animation */
        @keyframes favorite-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .favorite-animation {
            animation: favorite-animation 0.3s;
        }
        
        /* Location button styles */
        .location-button {
            position: absolute;
            bottom: 95px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .location-button:hover {
            background-color: #f0f0f0;
        }
        .dark .location-button {
            background-color: #3d3d3d;
            color: white;
        }
        .dark .location-button:hover {
            background-color: #4d4d4d;
        }
        
        /* RTL support for Persian */
        [dir="rtl"] body {
            font-family: Tahoma, Arial, sans-serif;
        }
        
        /* Larger more visible language selector */
        .lang-selector {
            position: relative;
            width: auto;
            cursor: pointer;
        }
        .lang-selector-current {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background-color: #f5f5f5;
            border-radius: 20px;
            font-weight: 500;
            color: #333;
            transition: all 0.2s;
        }
        .dark .lang-selector-current {
            background-color: #3d3d3d;
            color: #fff;
        }
        .lang-selector-current:hover {
            background-color: #e9e9e9;
        }
        .dark .lang-selector-current:hover {
            background-color: #4d4d4d;
        }
        .lang-selector-flag {
            width: 20px;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lang-selector-flag img {
            width: 20px;
            height: 20px;
            object-fit: cover;
        }
        .lang-selector-options {
            position: absolute;
            top: 110%;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .dark .lang-selector-options {
            background-color: #3d3d3d;
        }
        .lang-selector-options.show {
            opacity: 1;
            visibility: visible;
        }
        .lang-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            justify-content: center; /* Center text */
        }
        .lang-option:hover {
            background-color: #f5f5f5;
        }
        .dark .lang-option:hover {
            background-color: #4d4d4d;
        }
        .lang-option.active {
            background-color: #f0f0ff;
        }
        .dark .lang-option.active {
            background-color: #4a4a6a;
        }
        
        /* Center text in language selector */
        .lang-selector-current {
            justify-content: center;
            text-align: center;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.3s ease forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        .toast.hide {
            animation: fadeOutDown 0.3s ease forwards;
        }
        
        @keyframes fadeOutDown {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
        }
        
        /* Location name editor modal */
        .location-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }
        
        .location-name-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .location-name-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .dark .location-name-content {
            background-color: #2d2d2d;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div class="container mx-auto px-4 py-6 max-w-xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white" data-en="SkySense" data-fa="ÿßÿ≥⁄©ÿß€å‚Äåÿ≥ŸÜÿ≥">SkySense</h1>
            
            <div class="flex items-center gap-3">
                <!-- Language Selector -->
                <div class="lang-selector" id="lang-selector">
                    <div class="lang-selector-current">
                        <div class="lang-selector-flag">
                            <img src="https://cdn-icons-png.flaticon.com/512/323/323310.png" alt="English" id="current-lang-flag">
                        </div>
                        <span id="current-lang-name">EN</span>
                    </div>
                    <div class="lang-selector-options" id="lang-options">
                        <div class="lang-option active" data-lang="en">
                            <div class="lang-selector-flag">
                                <img src="https://cdn-icons-png.flaticon.com/512/323/323310.png" alt="English">
                            </div>
                            <span>English</span>
                        </div>
                        <div class="lang-option" data-lang="fa">
                            <div class="lang-selector-flag">
                                <img src="https://cdn-icons-png.flaticon.com/512/330/330549.png" alt="Persian">
                            </div>
                            <span>ŸÅÿßÿ±ÿ≥€å</span>
                        </div>
                    </div>
                </div>
                
                <!-- Unit Toggle -->
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 dark:text-gray-300" data-en="¬∞C" data-fa="¬∞C">¬∞C</span>
                    <div class="relative inline-block">
                        <input type="checkbox" id="unit-toggle" class="toggle-checkbox" />
                        <label for="unit-toggle" class="toggle-label">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                    <span class="text-gray-700 dark:text-gray-300" data-en="¬∞F" data-fa="¬∞F">¬∞F</span>
                </div>
                
                <!-- Settings Button -->
                <button id="settings-button" class="ml-2 p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
                    <i class="ti ti-settings text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Weather Alerts Container (IMPROVED) -->
        <div id="alerts-container" class="hidden relative border-l-4 p-4 rounded-lg mb-4 pulse-alert">
            <button id="dismiss-alert" class="alert-dismiss">
                <i class="ti ti-x"></i>
            </button>
            <div class="flex items-start">
                <i id="alert-icon" class="text-xl mr-2 mt-0.5"></i>
                <div>
                    <h3 class="font-semibold" id="alert-title" data-en="Weather Alert" data-fa="Ÿáÿ¥ÿØÿßÿ± ÿ¢ÿ® Ÿà ŸáŸàÿß">Weather Alert</h3>
                    <p class="text-sm" id="alert-message"></p>
                    
                    <!-- Alert actions/recommendations -->
                    <div id="alert-actions" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>
        
        <!-- Favorites Bar -->
        <div id="favorites-container" class="hidden mb-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300" data-en="Favorite Locations" data-fa="ŸÖ⁄©ÿßŸÜ‚ÄåŸáÿß€å ŸÖŸàÿ±ÿØ ÿπŸÑÿßŸÇŸá">Favorite Locations</h3>
                    <button id="manage-favorites" class="text-xs text-primary hover:underline" data-en="Manage" data-fa="ŸÖÿØ€åÿ±€åÿ™">Manage</button>
                </div>
                <div id="favorites-list" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
        
        <!-- Search and Map Container - FIXED: Made search-container class and removed overflow-hidden -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg search-container mb-6">
            <div class="flex border-b dark:border-gray-700">
                <button id="searchTab" class="location-tab flex-1 py-3 text-center text-gray-800 dark:text-white font-medium active" data-en="Search Location" data-fa="ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ŸÖ⁄©ÿßŸÜ">Search Location</button>
                <button id="mapTab" class="location-tab flex-1 py-3 text-center text-gray-800 dark:text-white font-medium" data-en="Pin on Map" data-fa="ŸÜÿ¥ÿßŸÜŸá‚Äå⁄Øÿ∞ÿßÿ±€å ÿ±Ÿà€å ŸÜŸÇÿ¥Ÿá">Pin on Map</button>
            </div>
            
            <!-- FIXED: Added padding-bottom to ensure dropdown visibility -->
            <div id="searchPanel" class="p-6 pb-24">
                <div id="autocompleteContainer">
                    <form id="weatherForm" class="flex flex-col md:flex-row gap-2">
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                id="locationInput" 
                                placeholder="City, mountain, desert, sea coordinates..." 
                                data-placeholder-en="City, mountain, desert, sea coordinates..."
                                data-placeholder-fa="ÿ¥Ÿáÿ±ÿå ⁄©ŸàŸáÿå ÿ®€åÿßÿ®ÿßŸÜÿå ŸÖÿÆÿ™ÿµÿßÿ™ ÿØÿ±€åÿß..."
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
                                autocomplete="off"
                                required
                            >
                            <div id="autocomplete-list"></div>
                        </div>
                        <button 
                            type="submit" 
                            class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                        >
                            <i class="ti ti-search mr-1"></i> <span data-en="Search" data-fa="ÿ¨ÿ≥ÿ™ÿ¨Ÿà">Search</span>
                        </button>
                    </form>
                </div>
            </div>
            
            <div id="mapPanel" class="hidden p-4">
                <div id="map" class="mb-4">
                    <!-- Location Button will be added here by JS -->
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" data-en="Click anywhere on the map to get weather for that exact location (mountains, deserts, seas, etc.)." data-fa="ÿ®ÿ±ÿß€å ÿØÿ±€åÿßŸÅÿ™ ÿ¢ÿ® Ÿà ŸáŸàÿß€å ÿØŸÇ€åŸÇ Ÿáÿ± ŸÖ⁄©ÿßŸÜ (⁄©ŸàŸáÿå ÿ®€åÿßÿ®ÿßŸÜÿå ÿØÿ±€åÿß Ÿà ÿ∫€åÿ±Ÿá) ÿ±Ÿà€å ŸÜŸÇÿ¥Ÿá ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ.">
                    Click anywhere on the map to get weather for that exact location (mountains, deserts, seas, etc.).
                </p>
                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <span class="text-gray-700 dark:text-gray-300" data-en="Selected point:" data-fa="ŸÜŸÇÿ∑Ÿá ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá:">Selected point:</span>
                    <span id="selectedLocation" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-full text-sm text-gray-800 dark:text-white" data-en="None selected" data-fa="Ÿá€å⁄Ü ŸÜŸÇÿ∑Ÿá‚Äåÿß€å ÿßŸÜÿ™ÿÆÿßÿ® ŸÜÿ¥ÿØŸá">None selected</span>
                </div>
                <button 
                    id="getWeatherForLocation" 
                    class="w-full px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50"
                    disabled
                    data-en="Get Weather"
                    data-fa="ÿØÿ±€åÿßŸÅÿ™ ÿ¢ÿ® Ÿà ŸáŸàÿß"
                >
                    Get Weather
                </button>
            </div>
        </div>
        
        <div id="loadingContainer" class="flex justify-center items-center py-10">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-700 dark:text-gray-300" id="loadingText" data-en="Getting your location..." data-fa="ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ ŸÖŸàŸÇÿπ€åÿ™ ÿ¥ŸÖÿß...">Getting your location...</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" id="permissionText" data-en="Please allow location access when prompted" data-fa="ŸÑÿ∑ŸÅÿßŸã ŸáŸÜ⁄ØÿßŸÖ ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ÿå ÿßÿ¨ÿßÿ≤Ÿá ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá ŸÖŸàŸÇÿπ€åÿ™ ŸÖ⁄©ÿßŸÜ€å ÿ±ÿß ÿ®ÿØŸá€åÿØ">Please allow location access when prompted</p>
            </div>
        </div>

        <div id="weatherContainer" class="hidden">
            <!-- Current Weather Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-4">
                <div class="flex justify-between items-start px-4 pt-4">
                    <h2 id="locationName" class="text-2xl font-bold text-gray-800 dark:text-white"></h2>
                    <div class="flex items-center gap-2">
                        <button id="rename-location" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Rename location">
                            <i class="ti ti-pencil text-xl"></i>
                        </button>
                        <button id="share-button" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
                            <i class="ti ti-share text-xl"></i>
                        </button>
                        <button id="favorite-button" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
                            <i class="ti ti-star text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div id="weatherHeader" class="p-6 flex flex-col md:flex-row items-center gap-4">
                    <div id="weatherIconContainer" class="flex-shrink-0 weather-icon"></div>
                    <div class="flex-1">
                        <p id="weatherDescription" class="text-gray-600 dark:text-gray-300 mb-3 text-center md:text-left"></p>
                        <div class="flex flex-wrap gap-x-6 gap-y-2">
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium" data-en="Temperature:" data-fa="ÿØŸÖÿß:">Temperature:</span>
                                <span id="temperature" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium" data-en="Feels like:" data-fa="ÿßÿ≠ÿ≥ÿßÿ≥ ÿØŸÖÿß€å€å:">Feels like:</span>
                                <span id="feelsLike" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium" data-en="Humidity:" data-fa="ÿ±ÿ∑Ÿàÿ®ÿ™:">Humidity:</span>
                                <span id="humidity" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-700 dark:text-gray-300 font-medium" data-en="Wind:" data-fa="ÿ®ÿßÿØ:">Wind:</span>
                                <span id="wind" class="ml-2 text-gray-900 dark:text-white"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expandable Weather Details -->
                <div class="px-6 pb-4">
                    <button id="details-toggle" class="w-full flex justify-between items-center text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary focus:outline-none transition-colors">
                        <span class="font-medium" data-en="Weather Details" data-fa="ÿ¨ÿ≤ÿ¶€åÿßÿ™ ÿ¢ÿ® Ÿà ŸáŸàÿß">Weather Details</span>
                        <i class="ti ti-chevron-down transition-transform duration-200"></i>
                    </button>
                    
                    <div id="details-content" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400" data-en="UV Index" data-fa="ÿ¥ÿßÿÆÿµ UV">UV Index</p>
                                <p id="uv-index" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400" data-en="Precipitation" data-fa="ÿ®ÿßÿ±ÿ¥">Precipitation</p>
                                <p id="precipitation" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400" data-en="Sunrise" data-fa="ÿ∑ŸÑŸàÿπ ÿ¢ŸÅÿ™ÿßÿ®">Sunrise</p>
                                <p id="sunrise" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400" data-en="Sunset" data-fa="ÿ∫ÿ±Ÿàÿ® ÿ¢ŸÅÿ™ÿßÿ®">Sunset</p>
                                <p id="sunset" class="text-lg font-medium text-gray-800 dark:text-white"></p>
                            </div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center" data-en="Wind Direction" data-fa="ÿ¨Ÿáÿ™ ÿ®ÿßÿØ">Wind Direction</p>
                                <div id="wind-compass" class="compass">
                                    <div class="compass-face">
                                        <div class="compass-direction">N</div>
                                        <div class="compass-direction" style="transform: rotate(90deg)">E</div>
                                        <div class="compass-direction" style="transform: rotate(180deg)">S</div>
                                        <div class="compass-direction" style="transform: rotate(270deg)">W</div>
                                        <div id="compass-arrow" class="compass-arrow"></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center" data-en="Historical Comparison" data-fa="ŸÖŸÇÿß€åÿ≥Ÿá ÿ™ÿßÿ±€åÿÆ€å">Historical Comparison</p>
                                <div id="historical-comparison" class="text-center px-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <p id="historical-text" class="text-sm text-gray-700 dark:text-gray-300" data-en="Loading historical data..." data-fa="ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ™ÿßÿ±€åÿÆ€å...">Loading historical data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hourly Forecast -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-4">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white" data-en="24-Hour Forecast" data-fa="Ÿæ€åÿ¥‚Äåÿ®€åŸÜ€å €≤€¥ ÿ≥ÿßÿπÿ™Ÿá">24-Hour Forecast</h3>
                </div>
                <div class="p-4 forecast-container">
                    <div id="hourlyForecastContent" class="flex gap-3 min-w-full"></div>
                </div>
            </div>
            
            <!-- Middle Ad Yektanet -->
            <div id="pos-article-display-card-105911" class="content-promotion horizontal mb-4"></div>
            
            <!-- 7-Day Forecast with Temperature Graph -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white" data-en="7-Day Forecast" data-fa="Ÿæ€åÿ¥‚Äåÿ®€åŸÜ€å €∑ ÿ±Ÿàÿ≤Ÿá">7-Day Forecast</h3>
                </div>
                
                <div class="p-4">
                    <div class="mb-4 h-48">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                    
                    <div class="forecast-container pb-2">
                        <div id="forecastContent" class="flex gap-3 min-w-full"></div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Ad Yektanet -->
            <div id="pos-article-display-card-105911" class="content-promotion horizontal"></div>
        </div>
        
        <div id="errorContainer" class="hidden bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-100 p-4 rounded-lg mt-4">
            <p id="errorMessage"></p>
        </div>
    </div>
    
    <!-- Location Name Modal -->
    <div id="locationNameModal" class="location-name-modal">
        <div class="location-name-content">
            <h3 class="text-xl font-semibold mb-4" data-en="Name this location" data-fa="ŸÜÿßŸÖ‚Äå⁄Øÿ∞ÿßÿ±€å ÿß€åŸÜ ŸÖ⁄©ÿßŸÜ">Name this location</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" data-en="Give this location a name you'll remember" data-fa="ÿ®Ÿá ÿß€åŸÜ ŸÖ⁄©ÿßŸÜ ŸÜÿßŸÖ€å ÿ®ÿØŸá€åÿØ ⁄©Ÿá ÿ®Ÿá ÿÆÿßÿ∑ÿ± ÿ®ÿ≥Ÿæÿßÿ±€åÿØ">Give this location a name you'll remember</p>
            
            <div class="mb-4">
                <input type="text" id="customLocationName" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" placeholder="e.g. Home, Work, Favorite Beach...">
            </div>
            
            <div class="flex justify-end gap-2">
                <button id="cancelLocationName" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg" data-en="Cancel" data-fa="ÿßŸÜÿµÿ±ÿßŸÅ">Cancel</button>
                <button id="saveLocationName" class="px-4 py-2 bg-primary text-white rounded-lg" data-en="Save" data-fa="ÿ∞ÿÆ€åÿ±Ÿá">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="settings-backdrop"></div>
        <div class="relative max-w-md mx-auto mt-20 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white" data-en="Customize Dashboard" data-fa="ÿ¥ÿÆÿµ€å‚Äåÿ≥ÿßÿ≤€å ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ">Customize Dashboard</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="ti ti-x text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" data-en="Select which weather elements to display:" data-fa="ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ ⁄©Ÿá ⁄©ÿØÿßŸÖ ÿπŸÜÿßÿµÿ± ÿ¢ÿ® Ÿà ŸáŸàÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ÿ¥ŸàŸÜÿØ:">Select which weather elements to display:</p>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label for="show-hourly" class="text-gray-700 dark:text-gray-300" data-en="Hourly Forecast" data-fa="Ÿæ€åÿ¥‚Äåÿ®€åŸÜ€å ÿ≥ÿßÿπÿ™€å">Hourly Forecast</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-hourly" class="toggle-checkbox" checked />
                            <label for="show-hourly" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-details" class="text-gray-700 dark:text-gray-300" data-en="Weather Details" data-fa="ÿ¨ÿ≤ÿ¶€åÿßÿ™ ÿ¢ÿ® Ÿà ŸáŸàÿß">Weather Details</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-details" class="toggle-checkbox" checked />
                            <label for="show-details" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-chart" class="text-gray-700 dark:text-gray-300" data-en="Temperature Chart" data-fa="ŸÜŸÖŸàÿØÿßÿ± ÿØŸÖÿß">Temperature Chart</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-chart" class="toggle-checkbox" checked />
                            <label for="show-chart" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-alerts" class="text-gray-700 dark:text-gray-300" data-en="Weather Alerts" data-fa="Ÿáÿ¥ÿØÿßÿ±Ÿáÿß€å ÿ¢ÿ® Ÿà ŸáŸàÿß">Weather Alerts</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-alerts" class="toggle-checkbox" checked />
                            <label for="show-alerts" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="show-historical" class="text-gray-700 dark:text-gray-300" data-en="Historical Comparison" data-fa="ŸÖŸÇÿß€åÿ≥Ÿá ÿ™ÿßÿ±€åÿÆ€å">Historical Comparison</label>
                        <div class="relative inline-block">
                            <input type="checkbox" id="show-historical" class="toggle-checkbox" checked />
                            <label for="show-historical" class="toggle-label">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 text-right">
                    <button id="save-settings" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors" data-en="Save Preferences" data-fa="ÿ∞ÿÆ€åÿ±Ÿá ÿ™ŸÜÿ∏€åŸÖÿßÿ™">
                        Save Preferences
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="share-backdrop"></div>
        <div class="relative max-w-md mx-auto mt-20 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white" data-en="Share Weather" data-fa="ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å ÿ¢ÿ® Ÿà ŸáŸàÿß">Share Weather</h3>
                <button id="close-share" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="ti ti-x text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" data-en="Share this weather information with others:" data-fa="ÿß€åŸÜ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¢ÿ® Ÿà ŸáŸàÿß ÿ±ÿß ÿ®ÿß ÿØ€å⁄Øÿ±ÿßŸÜ ÿ®Ÿá ÿßÿ¥ÿ™ÿ±ÿß⁄© ÿ®⁄Øÿ∞ÿßÿ±€åÿØ:">Share this weather information with others:</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-en="Share Link" data-fa="ŸÑ€åŸÜ⁄© ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å">Share Link</label>
                    <div class="flex">
                        <input type="text" id="share-url" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-lg text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" readonly>
                        <button id="copy-link" class="px-4 py-2 bg-primary text-white rounded-r-lg hover:bg-opacity-90 transition-colors">
                            <i class="ti ti-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-center gap-4">
                    <a href="#" id="share-twitter" class="p-3 bg-[#1DA1F2] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-twitter text-xl"></i>
                    </a>
                    <a href="#" id="share-facebook" class="p-3 bg-[#1877F2] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-facebook text-xl"></i>
                    </a>
                    <a href="#" id="share-whatsapp" class="p-3 bg-[#25D366] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-whatsapp text-xl"></i>
                    </a>
                    <a href="#" id="share-telegram" class="p-3 bg-[#0088cc] text-white rounded-full hover:bg-opacity-90 transition-colors" target="_blank">
                        <i class="ti ti-brand-telegram text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Favorites Management Modal -->
    <div id="favorites-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="favorites-backdrop"></div>
        <div class="relative max-w-md mx-auto mt-20 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white" data-en="Manage Favorites" data-fa="ŸÖÿØ€åÿ±€åÿ™ ÿπŸÑÿßŸÇŸá‚ÄåŸÖŸÜÿØ€å‚ÄåŸáÿß">Manage Favorites</h3>
                <button id="close-favorites" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="ti ti-x text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="no-favorites" class="hidden text-center py-6 text-gray-500 dark:text-gray-400">
                    <i class="ti ti-star text-4xl mb-2"></i>
                    <p data-en="No favorite locations yet" data-fa="ŸáŸÜŸàÿ≤ ŸÖ⁄©ÿßŸÜ ŸÖŸàÿ±ÿØ ÿπŸÑÿßŸÇŸá‚Äåÿß€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™">No favorite locations yet</p>
                </div>
                
                <ul id="favorites-management-list" class="divide-y divide-gray-200 dark:divide-gray-700"></ul>
                
                <div class="mt-6 text-right">
                    <button id="done-favorites" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors" data-en="Done" data-fa="ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØ">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast for location services -->
    <div id="location-toast" class="toast hidden">
        <i class="ti ti-map-pin text-xl"></i>
        <span id="toast-message"></span>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Weather code to icon mapping for Open-Meteo
        const weatherIcons = {
            // Clear, Sunny
            0: '‚òÄÔ∏è', // Clear sky
            1: 'üå§Ô∏è', // Mainly clear
            2: '‚õÖ', // Partly cloudy
            3: '‚òÅÔ∏è', // Overcast
            
            // Fog, Mist
            45: 'üå´Ô∏è', // Fog
            48: 'üå´Ô∏è', // Depositing rime fog
            
            // Drizzle
            51: 'üåßÔ∏è', // Light drizzle
            53: 'üåßÔ∏è', // Moderate drizzle
            55: 'üåßÔ∏è', // Dense drizzle
            
            // Freezing Drizzle
            56: 'üåßÔ∏è', // Light freezing drizzle
            57: 'üåßÔ∏è', // Dense freezing drizzle
            
            // Rain
            61: 'üåßÔ∏è', // Slight rain
            63: 'üåßÔ∏è', // Moderate rain
            65: 'üåßÔ∏è', // Heavy rain
            
            // Freezing Rain
            66: 'üå®Ô∏è', // Light freezing rain
            67: 'üå®Ô∏è', // Heavy freezing rain
            
            // Snow
            71: '‚ùÑÔ∏è', // Slight snow fall
            73: '‚ùÑÔ∏è', // Moderate snow fall
            75: '‚ùÑÔ∏è', // Heavy snow fall
            
            // Snow Grains
            77: '‚ùÑÔ∏è', // Snow grains
            
            // Rain Showers
            80: 'üå¶Ô∏è', // Slight rain showers
            81: 'üå¶Ô∏è', // Moderate rain showers
            82: 'üå¶Ô∏è', // Violent rain showers
            
            // Snow Showers
            85: 'üå®Ô∏è', // Slight snow showers
            86: 'üå®Ô∏è', // Heavy snow showers
            
            // Thunderstorm
            95: '‚õàÔ∏è', // Thunderstorm
            96: '‚õàÔ∏è', // Thunderstorm with slight hail
            99: '‚õàÔ∏è', // Thunderstorm with heavy hail
            
            // Default
            undefined: 'üå°Ô∏è'
        };

        // WMO Weather interpretation codes to text descriptions
        const weatherDescriptions = {
            0: "Clear sky",
            1: "Mainly clear",
            2: "Partly cloudy",
            3: "Overcast",
            45: "Fog",
            48: "Depositing rime fog",
            51: "Light drizzle",
            53: "Moderate drizzle",
            55: "Dense drizzle",
            56: "Light freezing drizzle",
            57: "Dense freezing drizzle",
            61: "Slight rain",
            63: "Moderate rain",
            65: "Heavy rain",
            66: "Light freezing rain",
            67: "Heavy freezing rain",
            71: "Slight snow fall",
            73: "Moderate snow fall",
            75: "Heavy snow fall",
            77: "Snow grains",
            80: "Slight rain showers",
            81: "Moderate rain showers",
            82: "Violent rain showers",
            85: "Slight snow showers",
            86: "Heavy snow showers",
            95: "Thunderstorm",
            96: "Thunderstorm with slight hail",
            99: "Thunderstorm with heavy hail",
            undefined: "Unknown"
        };

        // Persian weather descriptions
        const weatherDescriptionsFa = {
            0: "ÿ¢ÿ≥ŸÖÿßŸÜ ÿµÿßŸÅ",
            1: "ÿπŸÖÿØÿ™ÿßŸã ÿµÿßŸÅ",
            2: "ŸÜ€åŸÖŸá ÿßÿ®ÿ±€å",
            3: "ÿßÿ®ÿ±€å",
            45: "ŸÖŸá",
            48: "ŸÖŸá ÿ≥ÿ±ŸÖÿßÿ≤ÿØŸá",
            51: "ŸÜŸÖ‚ÄåŸÜŸÖ ÿ®ÿßÿ±ÿßŸÜ ÿ≥ÿ®⁄©",
            53: "ŸÜŸÖ‚ÄåŸÜŸÖ ÿ®ÿßÿ±ÿßŸÜ ŸÖÿ™Ÿàÿ≥ÿ∑",
            55: "ŸÜŸÖ‚ÄåŸÜŸÖ ÿ®ÿßÿ±ÿßŸÜ ÿ¥ÿØ€åÿØ",
            56: "ŸÜŸÖ‚ÄåŸÜŸÖ ÿ®ÿßÿ±ÿßŸÜ €åÿÆ‚Äåÿ≤ÿØŸá ÿÆŸÅ€åŸÅ",
            57: "ŸÜŸÖ‚ÄåŸÜŸÖ ÿ®ÿßÿ±ÿßŸÜ €åÿÆ‚Äåÿ≤ÿØŸá ÿ¥ÿØ€åÿØ",
            61: "ÿ®ÿßÿ±ÿßŸÜ ÿ≥ÿ®⁄©",
            63: "ÿ®ÿßÿ±ÿßŸÜ ŸÖÿ™Ÿàÿ≥ÿ∑",
            65: "ÿ®ÿßÿ±ÿßŸÜ ÿ¥ÿØ€åÿØ",
            66: "ÿ®ÿßÿ±ÿßŸÜ €åÿÆ‚Äåÿ≤ÿØŸá ÿ≥ÿ®⁄©",
            67: "ÿ®ÿßÿ±ÿßŸÜ €åÿÆ‚Äåÿ≤ÿØŸá ÿ¥ÿØ€åÿØ",
            71: "ÿ®ÿ±ŸÅ ÿ≥ÿ®⁄©",
            73: "ÿ®ÿ±ŸÅ ŸÖÿ™Ÿàÿ≥ÿ∑",
            75: "ÿ®ÿ±ŸÅ ÿ≥ŸÜ⁄Ø€åŸÜ",
            77: "ÿØÿßŸÜŸá‚ÄåŸáÿß€å ÿ®ÿ±ŸÅ",
            80: "ÿ®ÿßÿ±ÿ¥‚ÄåŸáÿß€å ÿ≥ÿ®⁄© ÿ®ÿßÿ±ÿßŸÜ",
            81: "ÿ®ÿßÿ±ÿ¥‚ÄåŸáÿß€å ŸÖÿ™Ÿàÿ≥ÿ∑ ÿ®ÿßÿ±ÿßŸÜ",
            82: "ÿ®ÿßÿ±ÿ¥‚ÄåŸáÿß€å ÿ¥ÿØ€åÿØ ÿ®ÿßÿ±ÿßŸÜ",
            85: "ÿ®ÿßÿ±ÿ¥‚ÄåŸáÿß€å ÿ≥ÿ®⁄© ÿ®ÿ±ŸÅ",
            86: "ÿ®ÿßÿ±ÿ¥‚ÄåŸáÿß€å ÿ¥ÿØ€åÿØ ÿ®ÿ±ŸÅ",
            95: "ÿ±ÿπÿØ Ÿà ÿ®ÿ±ŸÇ",
            96: "ÿ±ÿπÿØ Ÿà ÿ®ÿ±ŸÇ ÿ®ÿß ÿ™⁄Øÿ±⁄Ø ÿ≥ÿ®⁄©",
            99: "ÿ±ÿπÿØ Ÿà ÿ®ÿ±ŸÇ ÿ®ÿß ÿ™⁄Øÿ±⁄Ø ÿ¥ÿØ€åÿØ",
            undefined: "ŸÜÿßŸÖÿ¥ÿÆÿµ"
        };

        // IMPROVED: More detailed weather alert information with recommendations
        const weatherAlertInfo = {
            // Rain alerts
            51: { severity: 1, icon: "ti ti-cloud-rain", actions: ["carry_umbrella", "drive_carefully"] },
            53: { severity: 1, icon: "ti ti-cloud-rain", actions: ["carry_umbrella", "drive_carefully"] },
            55: { severity: 2, icon: "ti ti-cloud-rain", actions: ["carry_umbrella", "drive_carefully", "flood_risk"] },
            
            // Freezing rain alerts
            56: { severity: 2, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully", "ice_risk"] },
            57: { severity: 2, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully", "ice_risk"] },
            
            // Rain alerts
            61: { severity: 1, icon: "ti ti-cloud-rain", actions: ["carry_umbrella", "drive_carefully"] },
            63: { severity: 2, icon: "ti ti-cloud-rain", actions: ["carry_umbrella", "drive_carefully", "flood_risk"] },
            65: { severity: 3, icon: "ti ti-cloud-rain", actions: ["stay_indoors", "flood_risk", "avoid_rivers"] },
            
            // Freezing Rain
            66: { severity: 2, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully", "ice_risk"] },
            67: { severity: 3, icon: "ti ti-snowflake", actions: ["stay_indoors", "avoid_travel", "ice_risk"] },
            
            // Snow
            71: { severity: 1, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully"] },
            73: { severity: 2, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully", "check_heating"] },
            75: { severity: 3, icon: "ti ti-snowflake", actions: ["stay_indoors", "avoid_travel", "check_heating", "snow_risk"] },
            77: { severity: 2, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully"] },
            
            // Rain Showers
            80: { severity: 1, icon: "ti ti-cloud-rain", actions: ["carry_umbrella"] },
            81: { severity: 2, icon: "ti ti-cloud-rain", actions: ["carry_umbrella", "drive_carefully"] },
            82: { severity: 3, icon: "ti ti-cloud-rain", actions: ["stay_indoors", "avoid_travel", "flood_risk"] },
            
            // Snow Showers
            85: { severity: 1, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully"] },
            86: { severity: 2, icon: "ti ti-snowflake", actions: ["dress_warmly", "drive_carefully", "check_heating"] },
            
            // Thunderstorm
            95: { severity: 3, icon: "ti ti-bolt", actions: ["stay_indoors", "unplug_electronics", "avoid_trees"] },
            96: { severity: 3, icon: "ti ti-bolt", actions: ["stay_indoors", "unplug_electronics", "avoid_trees", "hail_risk"] },
            99: { severity: 3, icon: "ti ti-bolt", actions: ["stay_indoors", "unplug_electronics", "avoid_trees", "hail_risk"] }
        };
        
        // Weather alert action recommendations
        const weatherAlertActions = {
            // English actions
            en: {
                carry_umbrella: { icon: "ti ti-umbrella", text: "Carry an umbrella" },
                drive_carefully: { icon: "ti ti-car", text: "Drive with caution" },
                dress_warmly: { icon: "ti ti-shirt", text: "Dress warmly in layers" },
                stay_indoors: { icon: "ti ti-home", text: "Stay indoors if possible" },
                avoid_travel: { icon: "ti ti-map", text: "Avoid unnecessary travel" },
                unplug_electronics: { icon: "ti ti-plug", text: "Unplug sensitive electronics" },
                avoid_trees: { icon: "ti ti-tree", text: "Avoid trees and open areas" },
                check_heating: { icon: "ti ti-temperature", text: "Check heating systems" },
                flood_risk: { icon: "ti ti-waves", text: "Be aware of flooding risks" },
                ice_risk: { icon: "ti ti-ice-skating", text: "Watch for icy surfaces" },
                snow_risk: { icon: "ti ti-snowflake", text: "Heavy snow may block roads" },
                hail_risk: { icon: "ti ti-ball-baseball", text: "Take cover from hail" },
                avoid_rivers: { icon: "ti ti-droplet", text: "Avoid rivers and streams" }
            },
            // Persian actions
            fa: {
                carry_umbrella: { icon: "ti ti-umbrella", text: "⁄Üÿ™ÿ± ŸáŸÖÿ±ÿßŸá ÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥€åÿØ" },
                drive_carefully: { icon: "ti ti-car", text: "ÿ®ÿß ÿßÿ≠ÿ™€åÿßÿ∑ ÿ±ÿßŸÜŸÜÿØ⁄Ø€å ⁄©ŸÜ€åÿØ" },
                dress_warmly: { icon: "ti ti-shirt", text: "ŸÑÿ®ÿßÿ≥ ⁄Øÿ±ŸÖ Ÿà ŸÑÿß€åŸá‚Äåÿß€å ÿ®ŸæŸàÿ¥€åÿØ" },
                stay_indoors: { icon: "ti ti-home", text: "ÿØÿ± ÿµŸàÿ±ÿ™ ÿßŸÖ⁄©ÿßŸÜ ÿØÿ± ÿÆÿßŸÜŸá ÿ®ŸÖÿßŸÜ€åÿØ" },
                avoid_travel: { icon: "ti ti-map", text: "ÿßÿ≤ ÿ≥ŸÅÿ±Ÿáÿß€å ÿ∫€åÿ±ÿ∂ÿ±Ÿàÿ±€å ÿÆŸàÿØÿØÿßÿ±€å ⁄©ŸÜ€åÿØ" },
                unplug_electronics: { icon: "ti ti-plug", text: "Ÿàÿ≥ÿß€åŸÑ ÿßŸÑ⁄©ÿ™ÿ±ŸàŸÜ€å⁄©€å ÿ≠ÿ≥ÿßÿ≥ ÿ±ÿß ÿßÿ≤ ÿ®ÿ±ŸÇ ÿ®⁄©ÿ¥€åÿØ" },
                avoid_trees: { icon: "ti ti-tree", text: "ÿßÿ≤ ÿØÿ±ÿÆÿ™ÿßŸÜ Ÿà ŸÅÿ∂ÿßŸáÿß€å ÿ®ÿßÿ≤ ÿØŸàÿ±€å ⁄©ŸÜ€åÿØ" },
                check_heating: { icon: "ti ti-temperature", text: "ÿ≥€åÿ≥ÿ™ŸÖ‚ÄåŸáÿß€å ⁄Øÿ±ŸÖÿß€åÿ¥€å ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ€åÿØ" },
                flood_risk: { icon: "ti ti-waves", text: "ŸÖÿ±ÿßŸÇÿ® ÿÆÿ∑ÿ± ÿ≥€åŸÑ ÿ®ÿßÿ¥€åÿØ" },
                ice_risk: { icon: "ti ti-ice-skating", text: "ŸÖÿ±ÿßŸÇÿ® ÿ≥ÿ∑Ÿàÿ≠ €åÿÆ‚Äåÿ≤ÿØŸá ÿ®ÿßÿ¥€åÿØ" },
                snow_risk: { icon: "ti ti-snowflake", text: "ÿ®ÿ±ŸÅ ÿ≥ŸÜ⁄Ø€åŸÜ ŸÖŸÖ⁄©ŸÜ ÿßÿ≥ÿ™ ÿ¨ÿßÿØŸá‚ÄåŸáÿß ÿ±ÿß ŸÖÿ≥ÿØŸàÿØ ⁄©ŸÜÿØ" },
                hail_risk: { icon: "ti ti-ball-baseball", text: "ÿßÿ≤ ÿ™⁄Øÿ±⁄Ø ŸæŸÜÿßŸá ÿ®⁄Ø€åÿ±€åÿØ" },
                avoid_rivers: { icon: "ti ti-droplet", text: "ÿßÿ≤ ÿ±ŸàÿØÿÆÿßŸÜŸá‚ÄåŸáÿß Ÿà ÿ¨Ÿà€åÿ®ÿßÿ±Ÿáÿß ÿØŸàÿ±€å ⁄©ŸÜ€åÿØ" }
            }
        };

        // DOM Elements
        const weatherForm = document.getElementById('weatherForm');
        const locationInput = document.getElementById('locationInput');
        const weatherContainer = document.getElementById('weatherContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingText = document.getElementById('loadingText');
        const permissionText = document.getElementById('permissionText');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const locationName = document.getElementById('locationName');
        const weatherDescription = document.getElementById('weatherDescription');
        const weatherIconContainer = document.getElementById('weatherIconContainer');
        const temperature = document.getElementById('temperature');
        const feelsLike = document.getElementById('feelsLike');
        const humidity = document.getElementById('humidity');
        const wind = document.getElementById('wind');
        const forecastContent = document.getElementById('forecastContent');
        const hourlyForecastContent = document.getElementById('hourlyForecastContent');
        const searchTab = document.getElementById('searchTab');
        const mapTab = document.getElementById('mapTab');
        const searchPanel = document.getElementById('searchPanel');
        const mapPanel = document.getElementById('mapPanel');
        const selectedLocation = document.getElementById('selectedLocation');
        const getWeatherForLocation = document.getElementById('getWeatherForLocation');
        const unitToggle = document.getElementById('unit-toggle');
        const alertsContainer = document.getElementById('alerts-container');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertIcon = document.getElementById('alert-icon');
        const alertActions = document.getElementById('alert-actions');
        const dismissAlert = document.getElementById('dismiss-alert');
        const detailsToggle = document.getElementById('details-toggle');
        const detailsContent = document.getElementById('details-content');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsBackdrop = document.getElementById('settings-backdrop');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');
        const shareButton = document.getElementById('share-button');
        const shareModal = document.getElementById('share-modal');
        const shareBackdrop = document.getElementById('share-backdrop');
        const closeShare = document.getElementById('close-share');
        const shareUrl = document.getElementById('share-url');
        const copyLink = document.getElementById('copy-link');
        const shareTwitter = document.getElementById('share-twitter');
        const shareFacebook = document.getElementById('share-facebook');
        const shareWhatsapp = document.getElementById('share-whatsapp');
        const shareTelegram = document.getElementById('share-telegram');
        const favoriteButton = document.getElementById('favorite-button');
        const favoritesContainer = document.getElementById('favorites-container');
        const favoritesList = document.getElementById('favorites-list');
        const manageFavorites = document.getElementById('manage-favorites');
        const favoritesModal = document.getElementById('favorites-modal');
        const favoritesBackdrop = document.getElementById('favorites-backdrop');
        const closeFavorites = document.getElementById('close-favorites');
        const doneFavorites = document.getElementById('done-favorites');
        const favoritesManagementList = document.getElementById('favorites-management-list');
        const noFavorites = document.getElementById('no-favorites');
        const autocompleteList = document.getElementById('autocomplete-list');
        const langSelector = document.getElementById('lang-selector');
        const langOptions = document.getElementById('lang-options');
        const currentLangName = document.getElementById('current-lang-name');
        const currentLangFlag = document.getElementById('current-lang-flag');
        const locationToast = document.getElementById('location-toast');
        const toastMessage = document.getElementById('toast-message');
        const renameLocationBtn = document.getElementById('rename-location');
        const locationNameModal = document.getElementById('locationNameModal');
        const customLocationNameInput = document.getElementById('customLocationName');
        const saveLocationNameBtn = document.getElementById('saveLocationName');
        const cancelLocationNameBtn = document.getElementById('cancelLocationName');
        
        // Settings elements
        const showHourly = document.getElementById('show-hourly');
        const showDetails = document.getElementById('show-details');
        const showChart = document.getElementById('show-chart');
        const showAlerts = document.getElementById('show-alerts');
        const showHistorical = document.getElementById('show-historical');
        
        // Chart object
        let temperatureChart = null;
        
        // Map variables
        let map = null;
        let marker = null;
        let locationButton = null;
        let selectedCoords = null;
        
        // Current location data
        let currentLocationData = null;
        let currentWeatherData = null;
        
        // Unit preference (default: metric)
        let useMetric = true;
        
        // Language preference (default: English)
        let currentLanguage = 'en';
        
        // User preferences
        const userPreferences = {
            showHourly: true,
            showDetails: true,
            showChart: true,
            showAlerts: true,
            showHistorical: true,
            useMetric: true,
            language: 'en',
            favorites: [],
            customLocationNames: {}, // Store custom location names
            dismissedAlerts: [] // Track dismissed alerts
        };
        
        // FIXED: API Fallback Detection
        let isIranianIP = false;
        
        // Initialize application
        function initApp() {
            console.log("Initializing app...");
            
            // Load user preferences
            loadUserPreferences();
            
            // Set up event listeners
            setupEventListeners();
            
            // Apply preferences to UI
            applyUserPreferences();
            
            // Set up language selector
            setupLanguageSelector();
            
            // IMPROVED: Detect if user is in Iran by checking connection to OpenWeatherMap
            // This helps us determine which API to use
            checkRegion();
            
            // Check for location permission parameters
            checkLocationPermissionParameters();
        }
        
        // IMPROVED: Check if user is in a region with API restrictions
        async function checkRegion() {
            try {
                // Try accessing OpenWeatherMap with a short timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2500);
                
                await fetch('https://api.openweathermap.org/data/2.5/weather?lat=35.7&lon=51.4&appid=4d8fb5b93d4af21d66a2948710284366', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                isIranianIP = false;
                console.log("Using OpenWeatherMap API");
            } catch (error) {
                // If it fails, likely due to network restrictions, use Open-Meteo first
                isIranianIP = true;
                console.log("Using Open-Meteo API as primary");
            }
        }
        
        // Load user preferences from sessionStorage
        function loadUserPreferences() {
            try {
                const savedPreferences = window.sessionStorage.getItem('skyweatherPrefs');
                if (savedPreferences) {
                    const parsedPrefs = JSON.parse(savedPreferences);
                    Object.assign(userPreferences, parsedPrefs);
                    useMetric = userPreferences.useMetric;
                    currentLanguage = userPreferences.language || 'en';
                    
                    // Initialize custom location names if needed
                    if (!userPreferences.customLocationNames) {
                        userPreferences.customLocationNames = {};
                    }
                    
                    // Initialize dismissed alerts if needed
                    if (!userPreferences.dismissedAlerts) {
                        userPreferences.dismissedAlerts = [];
                    }
                }
            } catch (err) {
                console.error("Error loading preferences:", err);
                // If there's an error, we'll just use the defaults
            }
        }
        
        // Save user preferences to sessionStorage
        function saveUserPreferences() {
            try {
                userPreferences.useMetric = useMetric;
                userPreferences.language = currentLanguage;
                window.sessionStorage.setItem('skyweatherPrefs', JSON.stringify(userPreferences));
            } catch (err) {
                console.error("Error saving preferences:", err);
                // Non-critical error, so we'll just log it
            }
        }
        
        // Apply user preferences to UI
        function applyUserPreferences() {
            // Apply unit toggle state
            unitToggle.checked = !userPreferences.useMetric;
            
            // Apply settings toggle states
            showHourly.checked = userPreferences.showHourly;
            showDetails.checked = userPreferences.showDetails;
            showChart.checked = userPreferences.showChart;
            showAlerts.checked = userPreferences.showAlerts;
            showHistorical.checked = userPreferences.showHistorical;
            
            // Apply language preference
            setLanguage(userPreferences.language || 'en');
            
            // Load favorites
            if (userPreferences.favorites && userPreferences.favorites.length > 0) {
                renderFavorites();
                favoritesContainer.classList.remove('hidden');
            }
            
            // If weather data is loaded, update the display with the current unit preference
            if (currentWeatherData && currentLocationData) {
                displayWeatherData(currentWeatherData, currentLocationData.displayName);
            }
        }
        
        // Set up language selector
        function setupLanguageSelector() {
            // Set current language in selector
            updateLanguageSelector(currentLanguage);
            
            // Set up language selector click handler
            langSelector.addEventListener('click', function(e) {
                e.stopPropagation();
                langOptions.classList.toggle('show');
            });
            
            // Set up language option click handlers
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const lang = this.getAttribute('data-lang');
                    setLanguage(lang);
                    langOptions.classList.remove('show');
                });
            });
            
            // Close language selector when clicking outside
            document.addEventListener('click', function() {
                langOptions.classList.remove('show');
            });
        }
        
        // Update language selector UI
        function updateLanguageSelector(lang) {
            document.querySelectorAll('.lang-option').forEach(option => {
                if (option.getAttribute('data-lang') === lang) {
                    option.classList.add('active');
                    const flagImg = option.querySelector('img').src;
                    const langName = lang.toUpperCase();
                    currentLangFlag.src = flagImg;
                    currentLangName.textContent = langName;
                } else {
                    option.classList.remove('active');
                }
            });
        }
        
        // Set application language
        function setLanguage(lang) {
            currentLanguage = lang;
            userPreferences.language = lang;
            saveUserPreferences();
            
            // Update language selector
            updateLanguageSelector(lang);
            
            // Set RTL for Persian
            if (lang === 'fa') {
                document.body.setAttribute('dir', 'rtl');
            } else {
                document.body.setAttribute('dir', 'ltr');
            }
            
            // Update all translatable UI elements
            document.querySelectorAll('[data-' + lang + ']').forEach(element => {
                const translation = element.getAttribute('data-' + lang);
                if (translation) {
                    element.textContent = translation;
                }
            });
            
            // Update placeholder for search input
            const placeholderAttr = 'data-placeholder-' + lang;
            if (locationInput.hasAttribute(placeholderAttr)) {
                locationInput.placeholder = locationInput.getAttribute(placeholderAttr);
            }
            
            // Update weather descriptions if weather data is loaded
            if (currentWeatherData && currentLocationData) {
                displayWeatherData(currentWeatherData, currentLocationData.displayName);
            }
        }
        
        // Show toast notification
        function showToast(message, duration = 3000) {
            toastMessage.textContent = message;
            locationToast.classList.remove('hidden');
            
            setTimeout(() => {
                locationToast.classList.add('hide');
                setTimeout(() => {
                    locationToast.classList.add('hidden');
                    locationToast.classList.remove('hide');
                }, 300);
            }, duration);
        }
        
        // Show the location name modal
        function showLocationNameModal() {
            // Pre-fill with current location display name if it's not coordinates
            if (currentLocationData && currentLocationData.displayName) {
                const isCoordinates = /[0-9.-]+¬∞/.test(currentLocationData.displayName);
                if (!isCoordinates) {
                    customLocationNameInput.value = currentLocationData.displayName;
                } else {
                    customLocationNameInput.value = '';
                }
            }
            
            locationNameModal.classList.add('show');
            customLocationNameInput.focus();
        }
        
        // Hide the location name modal
        function hideLocationNameModal() {
            locationNameModal.classList.remove('show');
            customLocationNameInput.value = '';
        }
        
        // Save custom location name
        function saveCustomLocationName() {
            const newName = customLocationNameInput.value.trim();
            if (!newName || !currentLocationData) {
                hideLocationNameModal();
                return;
            }
            
            // Generate location key
            const locationKey = `${currentLocationData.latitude.toFixed(4)},${currentLocationData.longitude.toFixed(4)}`;
            
            // Save custom name
            userPreferences.customLocationNames[locationKey] = newName;
            saveUserPreferences();
            
            // Update current display name
            currentLocationData.displayName = newName;
            locationName.textContent = newName;
            
            // Update any existing favorites with this location
            userPreferences.favorites.forEach(favorite => {
                // Check if this is the same location (using close-enough coordinates)
                if (Math.abs(favorite.latitude - currentLocationData.latitude) < 0.01 && 
                    Math.abs(favorite.longitude - currentLocationData.longitude) < 0.01) {
                    favorite.displayName = newName;
                }
            });
            
            // Re-render favorites
            renderFavorites();
            
            // Hide modal
            hideLocationNameModal();
            
            // Show confirmation
            showToast(currentLanguage === 'en' ? 
                "Location name saved" : 
                "ŸÜÿßŸÖ ŸÖ⁄©ÿßŸÜ ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ");
        }
        
        // Check if location services are enabled
        function checkLocationPermission() {
            return new Promise((resolve, reject) => {
                // Check if navigator.permissions is supported
                if (navigator.permissions) {
                    navigator.permissions.query({ name: 'geolocation' }).then(result => {
                        if (result.state === 'granted') {
                            resolve(true);
                        } else if (result.state === 'prompt') {
                            // Will prompt the user
                            resolve('prompt');
                        } else {
                            // Denied
                            reject(new Error('Location permission denied'));
                        }
                    });
                } else {
                    // If permissions API is not available, try a direct request with a short timeout
                    const timeoutId = setTimeout(() => {
                        reject(new Error('Location request timed out'));
                    }, 3000);
                    
                    navigator.geolocation.getCurrentPosition(
                        () => {
                            clearTimeout(timeoutId);
                            resolve(true);
                        },
                        (error) => {
                            clearTimeout(timeoutId);
                            reject(error);
                        },
                        { timeout: 2000, maximumAge: 0 }
                    );
                }
            });
        }
        
        // Check URL parameters for location permission
        function checkLocationPermissionParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if loading with location permission
            if (urlParams.has('useLocation') && urlParams.get('useLocation') === 'true') {
                getUserLocation();
                return;
            }
            
            // Check for other parameters
            if (urlParams.has('lat') && urlParams.has('lon')) {
                const lat = parseFloat(urlParams.get('lat'));
                const lon = parseFloat(urlParams.get('lon'));
                getWeatherByCoordinates(lat, lon);
                return;
            } else if (urlParams.has('loc')) {
                const loc = urlParams.get('loc');
                getWeatherByLocationName(loc);
                return;
            }
            
            // Start with permission request for location
            getUserLocation();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // Weather form submission
            weatherForm.addEventListener('submit', handleWeatherFormSubmit);
            
            // Map location weather button
            getWeatherForLocation.addEventListener('click', handleGetWeatherForLocation);
            
            // Tab switching
            searchTab.addEventListener('click', () => switchTab('search'));
            mapTab.addEventListener('click', () => switchTab('map'));
            
            // Unit toggle
            unitToggle.addEventListener('change', handleUnitToggle);
            
            // Details toggle
            detailsToggle.addEventListener('click', toggleDetails);
            
            // IMPROVED: Alert dismiss button
            dismissAlert.addEventListener('click', dismissWeatherAlert);
            
            // Settings modal
            settingsButton.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            if (settingsBackdrop) {
                settingsBackdrop.addEventListener('click', () => settingsModal.classList.add('hidden'));
            }
            closeSettings.addEventListener('click', () => settingsModal.classList.add('hidden'));
            saveSettings.addEventListener('click', handleSaveSettings);
            
            // Share modal
            shareButton.addEventListener('click', openShareModal);
            if (shareBackdrop) {
                shareBackdrop.addEventListener('click', () => shareModal.classList.add('hidden'));
            }
            closeShare.addEventListener('click', () => shareModal.classList.add('hidden'));
            copyLink.addEventListener('click', copyShareLink);
            
            // Location name modal
            renameLocationBtn.addEventListener('click', showLocationNameModal);
            saveLocationNameBtn.addEventListener('click', saveCustomLocationName);
            cancelLocationNameBtn.addEventListener('click', hideLocationNameModal);
            
            // Favorite button
            favoriteButton.addEventListener('click', toggleFavorite);
            
            // Favorites management
            if (manageFavorites) {
                manageFavorites.addEventListener('click', openFavoritesModal);
            }
            if (favoritesBackdrop) {
                favoritesBackdrop.addEventListener('click', () => favoritesModal.classList.add('hidden'));
            }
            if (closeFavorites) {
                closeFavorites.addEventListener('click', () => favoritesModal.classList.add('hidden'));
            }
            if (doneFavorites) {
                doneFavorites.addEventListener('click', () => favoritesModal.classList.add('hidden'));
            }
            
            // Location input for autocomplete
            locationInput.addEventListener('input', handleLocationInput);
            locationInput.addEventListener('keydown', handleAutocompleteKeydown);
            
            // Close autocomplete on click outside
            document.addEventListener('click', function(e) {
                if (!autocompleteList.contains(e.target) && e.target !== locationInput) {
                    autocompleteList.innerHTML = '';
                    autocompleteList.classList.remove('show');
                }
            });
        }
        
        // IMPROVED: Dismiss weather alert
        function dismissWeatherAlert() {
            if (!currentWeatherData || !currentWeatherData.current) return;
            
            // Add current weather code to dismissed alerts
            const weatherCode = currentWeatherData.current.weather_code;
            
            if (!userPreferences.dismissedAlerts.includes(weatherCode)) {
                userPreferences.dismissedAlerts.push(weatherCode);
                saveUserPreferences();
            }
            
            // Hide alert
            alertsContainer.classList.add('hidden');
        }
        
        // Handle weather form submission
        async function handleWeatherFormSubmit(e) {
            e.preventDefault();
            const location = locationInput.value.trim();
            
            if (!location) {
                showError(currentLanguage === 'en' ? 
                    "Please enter a location" : 
                    "ŸÑÿ∑ŸÅÿßŸã €å⁄© ŸÖ⁄©ÿßŸÜ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ");
                return;
            }
            
            await getWeatherByLocationName(location);
        }
        
        // Handle get weather for map location
        function handleGetWeatherForLocation() {
            if (selectedCoords) {
                const { lat, lng } = selectedCoords;
                
                // Check if we have a custom name for this location
                const locationKey = `${lat.toFixed(4)},${lng.toFixed(4)}`;
                const customName = userPreferences.customLocationNames[locationKey];
                
                // Use custom name if available, otherwise use coordinates
                const displayName = customName || `${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞`;
                
                getWeatherByCoordinates(lat, lng, displayName);
            }
        }
        
        // Switch between search and map tabs
        function switchTab(tab) {
            if (tab === 'search') {
                searchTab.classList.add('active');
                mapTab.classList.remove('active');
                searchPanel.classList.remove('hidden');
                mapPanel.classList.add('hidden');
            } else {
                mapTab.classList.add('active');
                searchTab.classList.remove('active');
                mapPanel.classList.remove('hidden');
                searchPanel.classList.add('hidden');
                
                // Initialize map if not already done
                if (!map) {
                    initMapOnFirstClick();
                } else {
                    // Refresh map size after tab change
                    setTimeout(() => {
                        if (map) map.invalidateSize();
                    }, 100);
                }
            }
        }
        
        // Handle unit toggle
        function handleUnitToggle() {
            useMetric = !unitToggle.checked;
            userPreferences.useMetric = useMetric;
            saveUserPreferences();
            
            // Update displayed weather data with new unit
            if (currentWeatherData && currentLocationData) {
                displayWeatherData(currentWeatherData, currentLocationData.displayName);
            }
        }
        
        // Toggle weather details section
        function toggleDetails() {
            const icon = detailsToggle.querySelector('i');
            if (detailsContent.classList.contains('hidden')) {
                detailsContent.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                detailsContent.classList.add('hidden');
                icon.style.transform = 'rotate(0)';
            }
        }
        
        // Save settings preferences
        function handleSaveSettings() {
            userPreferences.showHourly = showHourly.checked;
            userPreferences.showDetails = showDetails.checked;
            userPreferences.showChart = showChart.checked;
            userPreferences.showAlerts = showAlerts.checked;
            userPreferences.showHistorical = showHistorical.checked;
            
            saveUserPreferences();
            settingsModal.classList.add('hidden');
            
            // Update UI based on new preferences
            updateUIBasedOnPreferences();
        }
        
        // Update UI based on current preferences
        function updateUIBasedOnPreferences() {
            const hourlyForecastSection = hourlyForecastContent.closest('.bg-white');
            hourlyForecastSection.style.display = userPreferences.showHourly ? 'block' : 'none';
            
            // If details are shown and preference is to hide them, hide the content
            if (!userPreferences.showDetails && !detailsContent.classList.contains('hidden')) {
                toggleDetails();
            }
            
            // If chart preference is to hide, hide the chart section
            const chartSection = document.getElementById('temperatureChart').closest('div');
            chartSection.style.display = userPreferences.showChart ? 'block' : 'none';
            
            // Apply alert preference (only affects future alerts, doesn't hide current ones)
            // Current alerts will be updated next time weather data is fetched
        }
        
        // Initialize map on first click of map tab
        function initMapOnFirstClick() {
            console.log("Initializing map...");
            
            try {
                if (!L) {
                    console.error("Leaflet library not loaded.");
                    return;
                }
                
                map = L.map('map').setView([40.7128, -74.0060], 10); // Default to NYC
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Add click handler
                map.on('click', function(e) {
                    const { lat, lng } = e.latlng;
                    selectedCoords = { lat, lng };
                    
                    // Update or add marker - FIXED: Always remove old marker first
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker(e.latlng).addTo(map);
                    
                    // Update UI
                    selectedLocation.textContent = `${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞`;
                    getWeatherForLocation.disabled = false;
                });
                
                // Add a location button to the map
                addLocationButton();
                
                // If we have user coordinates, center the map there
                if (window.userCoordinates) {
                    const { latitude, longitude } = window.userCoordinates;
                    map.setView([latitude, longitude], 10);
                    
                    // FIXED: Add a marker for user's location but ensure we don't keep old markers
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([latitude, longitude]).addTo(map);
                } else if (currentLocationData && currentLocationData.latitude && currentLocationData.longitude) {
                    // Use current weather location if available
                    map.setView([currentLocationData.latitude, currentLocationData.longitude], 10);
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([currentLocationData.latitude, currentLocationData.longitude]).addTo(map);
                }
                
                // Refresh map on tab change (fixes rendering issues)
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
                
            } catch (error) {
                console.error("Error initializing map:", error);
                const mapErrorMessage = document.createElement('div');
                mapErrorMessage.innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        <p>${currentLanguage === 'en' ? 
                          "Could not initialize map. Please try refreshing the page." : 
                          "ŸÜŸÇÿ¥Ÿá ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å ŸÜÿ¥ÿØ. ŸÑÿ∑ŸÅÿß ÿµŸÅÿ≠Ÿá ÿ±ÿß ÿ±ŸÅÿ±ÿ¥ ⁄©ŸÜ€åÿØ."}</p>
                    </div>
                `;
                document.getElementById('map').appendChild(mapErrorMessage);
            }
        }
        
        // Add location button to map
        function addLocationButton() {
            if (!map || locationButton) return;
            
            locationButton = document.createElement('div');
            locationButton.className = 'location-button';
            locationButton.innerHTML = '<i class="ti ti-current-location"></i>';
            locationButton.title = currentLanguage === 'en' ? 
                'Go to my location' : 
                'ÿ®ÿ±Ÿà ÿ®Ÿá ŸÖŸàŸÇÿπ€åÿ™ ŸÖŸÜ';
            
            // FIXED: Improve location button behavior
            locationButton.addEventListener('click', function() {
                checkLocationServices();
            });
            
            document.getElementById('map').appendChild(locationButton);
        }
        
        // Check if location services are enabled before trying to get location
        function checkLocationServices() {
            // First, check if the browser supports geolocation
            if (!navigator.geolocation) {
                showToast(currentLanguage === 'en' ? 
                    "Your browser doesn't support geolocation" : 
                    "ŸÖÿ±Ÿàÿ±⁄Øÿ± ÿ¥ŸÖÿß ÿßÿ≤ ŸÖŸàŸÇÿπ€åÿ™‚Äå€åÿßÿ®€å Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äå⁄©ŸÜÿØ");
                return;
            }
            
            // Display loading indicator on the button itself
            if (locationButton) {
                locationButton.innerHTML = '<div class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>';
                locationButton.style.pointerEvents = 'none';
            }
            
            // Try to get permission state if available
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(permissionStatus => {
                        if (permissionStatus.state === 'granted') {
                            // We have permission, get location
                            getUserLocationForMap();
                        } else if (permissionStatus.state === 'prompt') {
                            // Will prompt the user
                            showToast(currentLanguage === 'en' ? 
                                "Please allow location access when prompted" : 
                                "ŸÑÿ∑ŸÅÿßŸã ŸáŸÜ⁄ØÿßŸÖ ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ÿå ÿßÿ¨ÿßÿ≤Ÿá ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá ŸÖŸàŸÇÿπ€åÿ™ ŸÖ⁄©ÿßŸÜ€å ÿ±ÿß ÿ®ÿØŸá€åÿØ");
                            getUserLocationForMap();
                        } else if (permissionStatus.state === 'denied') {
                            // User has denied permission
                            showToast(currentLanguage === 'en' ? 
                                "Location access denied. Please enable location services in your browser settings." : 
                                "ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá ŸÖŸàŸÇÿπ€åÿ™ ÿ±ÿØ ÿ¥ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿÆÿØŸÖÿßÿ™ ŸÖ⁄©ÿßŸÜ‚Äå€åÿßÿ®€å ÿ±ÿß ÿØÿ± ÿ™ŸÜÿ∏€åŸÖÿßÿ™ ŸÖÿ±Ÿàÿ±⁄Øÿ± ÿÆŸàÿØ ŸÅÿπÿßŸÑ ⁄©ŸÜ€åÿØ.");
                            
                            // Reset the button
                            if (locationButton) {
                                locationButton.innerHTML = '<i class="ti ti-current-location"></i>';
                                locationButton.style.pointerEvents = 'auto';
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Error checking permission:", error);
                        getUserLocationForMap(); // Try anyway
                    });
            } else {
                // If permissions API is not available, try directly
                getUserLocationForMap();
            }
        }
        
        // Get user's location specifically for the map
        function getUserLocationForMap() {
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    
                    // Save coordinates for later use
                    window.userCoordinates = { latitude, longitude };
                    
                    // Center map on user location
                    if (map) {
                        map.setView([latitude, longitude], 13);
                        
                        // FIXED: Always remove old marker first
                        if (marker) {
                            map.removeLayer(marker);
                        }
                        
                        // Add new marker
                        marker = L.marker([latitude, longitude]).addTo(map);
                        
                        // Update selected coordinates
                        selectedCoords = { lat: latitude, lng: longitude };
                        selectedLocation.textContent = `${latitude.toFixed(4)}¬∞, ${longitude.toFixed(4)}¬∞`;
                        getWeatherForLocation.disabled = false;
                    }
                    
                    // Reset the button
                    if (locationButton) {
                        locationButton.innerHTML = '<i class="ti ti-current-location"></i>';
                        locationButton.style.pointerEvents = 'auto';
                    }
                },
                error => {
                    console.error("Geolocation error:", error);
                    
                    // Reset the button
                    if (locationButton) {
                        locationButton.innerHTML = '<i class="ti ti-current-location"></i>';
                        locationButton.style.pointerEvents = 'auto';
                    }
                    
                    // Show appropriate error message
                    let errorMsg;
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = currentLanguage === 'en' ? 
                                "Location access denied. Please enable location in your device settings." : 
                                "ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá ŸÖŸàŸÇÿπ€åÿ™ ÿ±ÿØ ÿ¥ÿØ. ŸÑÿ∑ŸÅÿßŸã ŸÖ⁄©ÿßŸÜ‚Äå€åÿßÿ®€å ÿ±ÿß ÿØÿ± ÿ™ŸÜÿ∏€åŸÖÿßÿ™ ÿØÿ≥ÿ™⁄ØÿßŸá ÿÆŸàÿØ ŸÅÿπÿßŸÑ ⁄©ŸÜ€åÿØ.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = currentLanguage === 'en' ? 
                                "Location information is unavailable. Check your device's location settings." : 
                                "ÿßÿ∑ŸÑÿßÿπÿßÿ™ ŸÖŸàŸÇÿπ€åÿ™ ÿØÿ± ÿØÿ≥ÿ™ÿ±ÿ≥ ŸÜ€åÿ≥ÿ™. ÿ™ŸÜÿ∏€åŸÖÿßÿ™ ŸÖ⁄©ÿßŸÜ ÿØÿ≥ÿ™⁄ØÿßŸá ÿÆŸàÿØ ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ€åÿØ.";
                            break;
                        case error.TIMEOUT:
                            errorMsg = currentLanguage === 'en' ? 
                                "Location request timed out. Please try again." : 
                                "ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ŸÖŸàŸÇÿπ€åÿ™ ÿ®Ÿá Ÿæÿß€åÿßŸÜ ÿ±ÿ≥€åÿØ. ŸÑÿ∑ŸÅÿß ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.";
                            break;
                        default:
                            errorMsg = currentLanguage === 'en' ? 
                                "An unknown error occurred getting your location." : 
                                "ÿÆÿ∑ÿß€å ŸÜÿßÿ¥ŸÜÿßÿÆÿ™Ÿá ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ŸÖŸàŸÇÿπ€åÿ™ ÿ¥ŸÖÿß ÿ±ÿÆ ÿØÿßÿØŸá ÿßÿ≥ÿ™.";
                    }
                    showToast(errorMsg, 5000);
                },
                options
            );
        }
        
        // Get user's location for initial weather display
        function getUserLocation(fromMapButton = false) {
            if ('geolocation' in navigator) {
                const loadingMsg = currentLanguage === 'en' ? 
                    'Getting your location...' : 
                    'ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ ŸÖŸàŸÇÿπ€åÿ™ ÿ¥ŸÖÿß...';
                
                const permissionMsg = currentLanguage === 'en' ? 
                    'Please allow location access when prompted' : 
                    'ŸÑÿ∑ŸÅÿßŸã ŸáŸÜ⁄ØÿßŸÖ ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ÿå ÿßÿ¨ÿßÿ≤Ÿá ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá ŸÖŸàŸÇÿπ€åÿ™ ŸÖ⁄©ÿßŸÜ€å ÿ±ÿß ÿ®ÿØŸá€åÿØ';
                
                if (!fromMapButton) {
                    showLoading(loadingMsg);
                    permissionText.textContent = permissionMsg;
                    permissionText.style.display = 'block';
                }
                
                // Set a longer timeout for geolocation (30 seconds)
                const geolocationTimeout = setTimeout(() => {
                    console.log("Geolocation timed out, using default location");
                    if (!fromMapButton) {
                        hideLoading();
                        getWeatherByLocationName('New York'); // Fallback to a default city
                    }
                }, 30000); // 30 seconds timeout
                
                try {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            clearTimeout(geolocationTimeout);
                            const { latitude, longitude } = position.coords;
                            
                            // Save coordinates for later use
                            window.userCoordinates = { latitude, longitude };
                            
                            if (fromMapButton && map) {
                                map.setView([latitude, longitude], 13);
                                if (marker) {
                                    map.removeLayer(marker);
                                }
                                marker = L.marker([latitude, longitude]).addTo(map);
                                selectedCoords = { lat: latitude, lng: longitude };
                                selectedLocation.textContent = `${latitude.toFixed(4)}¬∞, ${longitude.toFixed(4)}¬∞`;
                                getWeatherForLocation.disabled = false;
                            } else {
                                // For current location, we'll use a friendly name
                                const displayName = currentLanguage === 'en' ? 
                                    'Your Location' : 
                                    'ŸÖŸàŸÇÿπ€åÿ™ ÿ¥ŸÖÿß';
                                
                                // Get weather for the detected coordinates
                                getWeatherByCoordinates(latitude, longitude, displayName);
                                
                                // Show the location renaming option
                                setTimeout(() => {
                                    showToast(currentLanguage === 'en' ? 
                                        "Tip: You can rename this location by clicking the pencil icon" : 
                                        "ŸÜ⁄©ÿ™Ÿá: ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ®ÿß ⁄©ŸÑ€å⁄© ÿ±Ÿà€å ÿ¢€å⁄©ŸàŸÜ ŸÖÿØÿßÿØÿå ŸÜÿßŸÖ ÿß€åŸÜ ŸÖ⁄©ÿßŸÜ ÿ±ÿß ÿ™ÿ∫€å€åÿ± ÿØŸá€åÿØ", 5000);
                                }, 2000);
                            }
                        }, 
                        error => {
                            clearTimeout(geolocationTimeout);
                            console.error("Geolocation error:", error);
                            
                            if (!fromMapButton) {
                                hideLoading();
                                // Show error message based on the error code
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        showError(currentLanguage === 'en' ? 
                                            "Location access denied. Please search for a location instead." : 
                                            "ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá ŸÖŸàŸÇÿπ€åÿ™ ÿ±ÿØ ÿ¥ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿ®Ÿá ÿ¨ÿß€å ÿ¢ŸÜ €å⁄© ŸÖ⁄©ÿßŸÜ ÿ±ÿß ÿ¨ÿ≥ÿ™ÿ¨Ÿà ⁄©ŸÜ€åÿØ.");
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        showError(currentLanguage === 'en' ? 
                                            "Location information is unavailable. Please search for a location." : 
                                            "ÿßÿ∑ŸÑÿßÿπÿßÿ™ ŸÖŸàŸÇÿπ€åÿ™ ÿØÿ± ÿØÿ≥ÿ™ÿ±ÿ≥ ŸÜ€åÿ≥ÿ™. ŸÑÿ∑ŸÅÿßŸã €å⁄© ŸÖ⁄©ÿßŸÜ ÿ±ÿß ÿ¨ÿ≥ÿ™ÿ¨Ÿà ⁄©ŸÜ€åÿØ.");
                                        break;
                                    case error.TIMEOUT:
                                        showError(currentLanguage === 'en' ? 
                                            "Location request timed out. Please search for a location." : 
                                            "ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ŸÖŸàŸÇÿπ€åÿ™ ÿ®Ÿá Ÿæÿß€åÿßŸÜ ÿ±ÿ≥€åÿØ. ŸÑÿ∑ŸÅÿßŸã €å⁄© ŸÖ⁄©ÿßŸÜ ÿ±ÿß ÿ¨ÿ≥ÿ™ÿ¨Ÿà ⁄©ŸÜ€åÿØ.");
                                        break;
                                    default:
                                        showError(currentLanguage === 'en' ? 
                                            "An unknown error occurred. Please search for a location." : 
                                            "ÿÆÿ∑ÿß€å ŸÜÿßÿ¥ŸÜÿßÿÆÿ™Ÿá ÿ±ÿÆ ÿØÿßÿØ. ŸÑÿ∑ŸÅÿßŸã €å⁄© ŸÖ⁄©ÿßŸÜ ÿ±ÿß ÿ¨ÿ≥ÿ™ÿ¨Ÿà ⁄©ŸÜ€åÿØ.");
                                }
                                
                                // Load a default location
                                getWeatherByLocationName('New York');
                            }
                        },
                        { 
                            enableHighAccuracy: true, // Use high accuracy to get precise location
                            timeout: 25000,  // 25 seconds timeout (shorter than the overall timeout)
                            maximumAge: 0    // Force fresh location (ignore cached)
                        }
                    );
                } catch (e) {
                    clearTimeout(geolocationTimeout);
                    console.error("Exception in geolocation:", e);
                    if (!fromMapButton) {
                        hideLoading();
                        getWeatherByLocationName('New York'); // Fallback to a default city
                    }
                }
            } else {
                console.log("Geolocation not supported");
                if (!fromMapButton) {
                    hideLoading();
                    showError(currentLanguage === 'en' ? 
                        "Your browser doesn't support geolocation. Please search for a location." : 
                        "ŸÖÿ±Ÿàÿ±⁄Øÿ± ÿ¥ŸÖÿß ÿßÿ≤ ŸÖŸàŸÇÿπ€åÿ™‚Äå€åÿßÿ®€å Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äå⁄©ŸÜÿØ. ŸÑÿ∑ŸÅÿßŸã €å⁄© ŸÖ⁄©ÿßŸÜ ÿ±ÿß ÿ¨ÿ≥ÿ™ÿ¨Ÿà ⁄©ŸÜ€åÿØ.");
                    
                    // Load a default location
                    getWeatherByLocationName('New York');
                }
            }
        }
        
        // Format temperature with units
        function formatTemperature(temp) {
            if (!useMetric) {
                // Convert to Fahrenheit
                temp = (temp * 9/5) + 32;
            }
            return `${Math.round(temp)}¬∞${useMetric ? 'C' : 'F'}`;
        }
        
        // Format date string from ISO date
        function formatDate(dateString) {
            const date = new Date(dateString);
            
            if (currentLanguage === 'fa') {
                // Simple Persian date format (not fully accurate but sufficient for this app)
                const days = ['€å⁄©ÿ¥ŸÜÿ®Ÿá', 'ÿØŸàÿ¥ŸÜÿ®Ÿá', 'ÿ≥Ÿá‚Äåÿ¥ŸÜÿ®Ÿá', '⁄ÜŸáÿßÿ±ÿ¥ŸÜÿ®Ÿá', 'ŸæŸÜÿ¨ÿ¥ŸÜÿ®Ÿá', 'ÿ¨ŸÖÿπŸá', 'ÿ¥ŸÜÿ®Ÿá'];
                const months = ['ŸÅÿ±Ÿàÿ±ÿØ€åŸÜ', 'ÿßÿ±ÿØ€åÿ®Ÿáÿ¥ÿ™', 'ÿÆÿ±ÿØÿßÿØ', 'ÿ™€åÿ±', 'ŸÖÿ±ÿØÿßÿØ', 'ÿ¥Ÿáÿ±€åŸàÿ±', 'ŸÖŸáÿ±', 'ÿ¢ÿ®ÿßŸÜ', 'ÿ¢ÿ∞ÿ±', 'ÿØ€å', 'ÿ®ŸáŸÖŸÜ', 'ÿßÿ≥ŸÅŸÜÿØ'];
                // Note: This is a simplified conversion, not accurate for all dates
                return `${days[date.getDay()]}ÿå ${date.getDate()} ${months[date.getMonth()]}`;
            } else {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
            }
        }
        
        // Format time from ISO date or hour string
        function formatTime(timeString) {
            let date;
            if (timeString.includes('T')) {
                // Full ISO date
                date = new Date(timeString);
            } else if (timeString.length === 2) {
                // Hour string (e.g., "09")
                date = new Date();
                date.setHours(parseInt(timeString, 10), 0, 0);
            } else {
                return timeString;
            }
            
            return date.toLocaleTimeString(currentLanguage === 'fa' ? 'fa-IR' : [], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Convert wind speed and direction to human-readable format
        function formatWind(speed, direction) {
            let formattedSpeed;
            
            if (useMetric) {
                // Converting m/s to km/h
                formattedSpeed = `${Math.round(speed * 3.6)} ${currentLanguage === 'en' ? 'km/h' : '⁄©€åŸÑŸàŸÖÿ™ÿ±/ÿ≥ÿßÿπÿ™'}`;
            } else {
                // Converting m/s to mph
                formattedSpeed = `${Math.round(speed * 2.237)} ${currentLanguage === 'en' ? 'mph' : 'ŸÖÿß€åŸÑ/ÿ≥ÿßÿπÿ™'}`;
            }
            
            // Get cardinal direction
            const directions = currentLanguage === 'en' ? 
                ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'] : 
                ['ÿ¥ŸÖÿßŸÑ', 'ÿ¥ŸÖÿßŸÑ‚Äåÿ¥ÿ±ŸÇ', 'ÿ¥ÿ±ŸÇ', 'ÿ¨ŸÜŸàÿ®‚Äåÿ¥ÿ±ŸÇ', 'ÿ¨ŸÜŸàÿ®', 'ÿ¨ŸÜŸàÿ®‚Äåÿ∫ÿ±ÿ®', 'ÿ∫ÿ±ÿ®', 'ÿ¥ŸÖÿßŸÑ‚Äåÿ∫ÿ±ÿ®'];
            
            const index = Math.round(direction / 45) % 8;
            
            return `${formattedSpeed} ${directions[index]}`;
        }
        
        // Create temperature chart
        function createTemperatureChart(dailyData) {
            if (!userPreferences.showChart) return;
            
            try {
                const ctx = document.getElementById('temperatureChart').getContext('2d');
                
                // Prepare data
                const labels = dailyData.time.map(formatDate);
                const maxTemps = dailyData.temperature_2m_max.map(temp => useMetric ? temp : (temp * 9/5) + 32);
                const minTemps = dailyData.temperature_2m_min.map(temp => useMetric ? temp : (temp * 9/5) + 32);
                
                // Destroy previous chart if it exists
                if (temperatureChart) {
                    temperatureChart.destroy();
                }
                
                // Create new chart
                temperatureChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: currentLanguage === 'en' ? 'Max Temp' : 'ÿØŸÖÿß€å ÿ≠ÿØÿß⁄©ÿ´ÿ±',
                                data: maxTemps,
                                borderColor: '#FF6B6B',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                fill: false,
                                tension: 0.4,
                                pointBackgroundColor: '#FF6B6B',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: currentLanguage === 'en' ? 'Min Temp' : 'ÿØŸÖÿß€å ÿ≠ÿØÿßŸÇŸÑ',
                                data: minTemps,
                                borderColor: '#4ECDC4',
                                backgroundColor: 'rgba(78, 205, 196, 0.1)',
                                fill: false,
                                tension: 0.4,
                                pointBackgroundColor: '#4ECDC4',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#f1f1f1' : '#333'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#f1f1f1' : '#333',
                                    callback: function(value) {
                                        return value + '¬∞' + (useMetric ? 'C' : 'F');
                                    }
                                },
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#f1f1f1' : '#333'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creating temperature chart:", error);
            }
        }
        
        // IMPROVED: Handle location autocomplete with fallback between APIs
        let autocompleteTimeout;
        async function handleLocationInput() {
            const query = locationInput.value.trim();
            
            if (query.length < 2) {
                autocompleteList.innerHTML = '';
                autocompleteList.classList.remove('show');
                return;
            }
            
            // Clear previous timeout to avoid rapid API calls
            clearTimeout(autocompleteTimeout);
            
            // Set a timeout to allow user to finish typing
            autocompleteTimeout = setTimeout(async () => {
                try {
                    console.log("Fetching autocomplete for:", query);
                    
                    let results = [];
                    
                    // Try Open-Meteo first for Iranian users
                    if (isIranianIP) {
                        try {
                            const response = await fetchWithTimeout(
                                `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=${currentLanguage}`,
                                { timeout: 3000 }
                            );
                            const data = await response.json();
                            if (data.results && data.results.length > 0) {
                                results = data.results.map(item => ({
                                    name: item.name,
                                    country: item.country,
                                    state: item.admin1
                                }));
                            }
                        } catch (error) {
                            console.log("Open-Meteo autocomplete failed, trying OpenWeatherMap");
                        }
                    }
                    
                    // If no results yet or not in Iran, try OpenWeatherMap
                    if (results.length === 0) {
                        try {
                            const response = await fetchWithTimeout(
                                `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(query)}&limit=5&appid=4d8fb5b93d4af21d66a2948710284366`,
                                { timeout: 3000 }
                            );
                            const data = await response.json();
                            if (data && data.length > 0) {
                                results = data;
                            }
                        } catch (error) {
                            console.error("OpenWeatherMap autocomplete failed");
                            // If in Iran and both APIs failed, show error
                            if (isIranianIP) {
                                throw new Error("All geocoding APIs failed");
                            }
                        }
                    }
                    
                    if (results.length === 0) {
                        autocompleteList.innerHTML = '';
                        autocompleteList.classList.remove('show');
                        return;
                    }
                    
                    // Display results
                    renderAutocompleteResults(results);
                } catch (err) {
                    console.error("Autocomplete error:", err);
                    autocompleteList.innerHTML = '';
                    autocompleteList.classList.remove('show');
                }
            }, 300);
        }
        
        // IMPROVED: Fetch with timeout for faster error handling
        function fetchWithTimeout(url, options = {}) {
            const { timeout = 5000 } = options;
            
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timed out')), timeout)
                )
            ]);
        }
        
        // Render autocomplete results - FIXED
        function renderAutocompleteResults(results) {
            // Clear previous results first
            autocompleteList.innerHTML = '';
            
            console.log("Got autocomplete results:", results.length);
            
            results.forEach(location => {
                const div = document.createElement('div');
                const locationName = [
                    location.name,
                    location.state,
                    location.country
                ].filter(Boolean).join(', ');
                
                div.textContent = locationName;
                div.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent bubbling
                    locationInput.value = locationName;
                    autocompleteList.innerHTML = '';
                    autocompleteList.classList.remove('show');
                    // Submit the form
                    weatherForm.dispatchEvent(new Event('submit'));
                });
                autocompleteList.appendChild(div);
            });
            
            // Show the autocomplete list
            autocompleteList.classList.add('show');
        }
        
        // Handle keyboard navigation in autocomplete
        function handleAutocompleteKeydown(e) {
            if (!autocompleteList.classList.contains('show')) return;
            
            const items = autocompleteList.querySelectorAll('div');
            if (items.length === 0) return;
            
            let activeItem = autocompleteList.querySelector('.autocomplete-active');
            let activeIndex = Array.from(items).indexOf(activeItem);
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (activeItem) activeItem.classList.remove('autocomplete-active');
                    activeIndex = activeIndex >= 0 ? Math.min(activeIndex + 1, items.length - 1) : 0;
                    items[activeIndex].classList.add('autocomplete-active');
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (activeItem) activeItem.classList.remove('autocomplete-active');
                    activeIndex = activeIndex > 0 ? activeIndex - 1 : 0;
                    items[activeIndex].classList.add('autocomplete-active');
                    break;
                case 'Enter':
                    if (activeItem) {
                        e.preventDefault();
                        activeItem.click();
                    }
                    break;
                case 'Escape':
                    autocompleteList.innerHTML = '';
                    autocompleteList.classList.remove('show');
                    break;
            }
        }
        
        // Update wind direction compass
        function updateWindCompass(direction) {
            const arrow = document.getElementById('compass-arrow');
            if (arrow) {
                arrow.style.transform = `translate(-50%, -100%) rotate(${direction}deg)`;
            }
        }
        
        // IMPROVED: Check weather conditions for alerts with more detailed information
        function checkWeatherAlerts(data) {
            if (!userPreferences.showAlerts) {
                alertsContainer.classList.add('hidden');
                return;
            }
            
            // Check current weather code for severe conditions
            const currentWeatherCode = data.current.weather_code;
            
            // Check if this alert has been dismissed
            if (userPreferences.dismissedAlerts.includes(currentWeatherCode)) {
                alertsContainer.classList.add('hidden');
                return;
            }
            
            // Get alert info for this weather code
            const alertInfo = weatherAlertInfo[currentWeatherCode];
            
            // Check if precipitation is high
            const hasPrecipitation = (data.daily && data.daily.precipitation_sum && 
                                     data.daily.precipitation_sum[0] > 20); // More than 20mm is significant
            
            // Check wind speed for high winds
            const highWinds = data.current.wind_speed_10m > 15; // More than 15 m/s is significant
            
            // Create a custom alert if precipitation or high winds without a specific code alert
            if (!alertInfo && (hasPrecipitation || highWinds)) {
                // Clear any previous alert classes
                alertsContainer.className = 'relative border-l-4 p-4 rounded-lg mb-4 pulse-alert';
                
                // Add the appropriate severity class
                const severityClass = hasPrecipitation && highWinds ? 'alert-severity-3' : 'alert-severity-2';
                alertsContainer.classList.add(severityClass);
                
                // Update alert icon
                alertIcon.className = hasPrecipitation ? 'ti ti-cloud-rain text-xl mr-2 mt-0.5' : 'ti ti-wind text-xl mr-2 mt-0.5';
                
                // Create alert message
                const descriptionText = currentLanguage === 'en' ? 
                    weatherDescriptions[currentWeatherCode] : 
                    weatherDescriptionsFa[currentWeatherCode];
                
                let alertText = descriptionText;
                
                if (hasPrecipitation) {
                    if (currentLanguage === 'en') {
                        alertText += ` | Heavy precipitation expected (${data.daily.precipitation_sum[0]}mm)`;
                    } else {
                        alertText += ` | ÿ®ÿßÿ±ÿ¥ ÿ¥ÿØ€åÿØ Ÿæ€åÿ¥‚Äåÿ®€åŸÜ€å ŸÖ€å‚Äåÿ¥ŸàÿØ (${data.daily.precipitation_sum[0]} ŸÖ€åŸÑ€å‚ÄåŸÖÿ™ÿ±)`;
                    }
                }
                
                if (highWinds) {
                    if (currentLanguage === 'en') {
                        alertText += ` | Strong winds (${formatWind(data.current.wind_speed_10m, data.current.wind_direction_10m)})`;
                    } else {
                        alertText += ` | ÿ®ÿßÿØŸáÿß€å ÿ¥ÿØ€åÿØ (${formatWind(data.current.wind_speed_10m, data.current.wind_direction_10m)})`;
                    }
                }
                
                // Display alert
                alertTitle.textContent = currentLanguage === 'en' ? "Weather Alert" : "Ÿáÿ¥ÿØÿßÿ± ÿ¢ÿ® Ÿà ŸáŸàÿß";
                alertMessage.textContent = alertText;
                
                // Add appropriate actions
                alertActions.innerHTML = '';
                const recommendedActions = [];
                
                if (hasPrecipitation) {
                    recommendedActions.push('carry_umbrella', 'drive_carefully');
                    if (data.daily.precipitation_sum[0] > 30) {
                        recommendedActions.push('flood_risk');
                    }
                }
                
                if (highWinds) {
                    recommendedActions.push('drive_carefully');
                    if (data.current.wind_speed_10m > 20) {
                        recommendedActions.push('avoid_travel');
                    }
                }
                
                recommendedActions.forEach(action => {
                    const actionInfo = weatherAlertActions[currentLanguage][action];
                    const actionEl = document.createElement('div');
                    actionEl.className = 'alert-action-item';
                    actionEl.innerHTML = `<i class="${actionInfo.icon}"></i> <span>${actionInfo.text}</span>`;
                    alertActions.appendChild(actionEl);
                });
                
                alertsContainer.classList.remove('hidden');
            }
            // If we have specific alert info for this weather code
            else if (alertInfo && alertInfo.severity > 0) {
                // Clear any previous alert classes
                alertsContainer.className = 'relative border-l-4 p-4 rounded-lg mb-4 pulse-alert';
                
                // Add the appropriate severity class
                alertsContainer.classList.add(`alert-severity-${alertInfo.severity}`);
                
                // Update alert icon
                alertIcon.className = `${alertInfo.icon} text-xl mr-2 mt-0.5`;
                
                // Create alert message
                const descriptionText = currentLanguage === 'en' ? 
                    weatherDescriptions[currentWeatherCode] : 
                    weatherDescriptionsFa[currentWeatherCode];
                
                // Display alert
                alertTitle.textContent = currentLanguage === 'en' ? "Weather Alert" : "Ÿáÿ¥ÿØÿßÿ± ÿ¢ÿ® Ÿà ŸáŸàÿß";
                alertMessage.textContent = descriptionText;
                
                // Add recommended actions
                alertActions.innerHTML = '';
                alertInfo.actions.forEach(action => {
                    const actionInfo = weatherAlertActions[currentLanguage][action];
                    const actionEl = document.createElement('div');
                    actionEl.className = 'alert-action-item';
                    actionEl.innerHTML = `<i class="${actionInfo.icon}"></i> <span>${actionInfo.text}</span>`;
                    alertActions.appendChild(actionEl);
                });
                
                alertsContainer.classList.remove('hidden');
            } else {
                alertsContainer.classList.add('hidden');
            }
        }
        
        // Open share modal
        function openShareModal() {
            if (!currentLocationData) return;
            
            // Create share URL
            let shareUrlText = window.location.href.split('?')[0];
            
            if (currentLocationData.latitude && currentLocationData.longitude) {
                shareUrlText += `?lat=${currentLocationData.latitude}&lon=${currentLocationData.longitude}`;
            } else if (currentLocationData.name) {
                shareUrlText += `?loc=${encodeURIComponent(currentLocationData.name)}`;
            }
            
            shareUrl.value = shareUrlText;
            
            // Set up social sharing links
            const weatherDesc = currentLanguage === 'en' ? 
                weatherDescriptions[currentWeatherData.current.weather_code] : 
                weatherDescriptionsFa[currentWeatherData.current.weather_code];
            
            const shareTitle = currentLanguage === 'en' ? 
                `Check out the weather in ${currentLocationData.displayName}` : 
                `ÿ¢ÿ® Ÿà ŸáŸàÿß ÿØÿ± ${currentLocationData.displayName} ÿ±ÿß ÿ®ÿ®€åŸÜ€åÿØ`;
            
            const weatherText = encodeURIComponent(`${shareTitle}: ${weatherDesc}, ${temperature.textContent}`);
            
            shareTwitter.href = `https://twitter.com/intent/tweet?text=${weatherText}&url=${encodeURIComponent(shareUrlText)}`;
            shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrlText)}`;
            shareWhatsapp.href = `https://wa.me/?text=${weatherText} ${encodeURIComponent(shareUrlText)}`;
            shareTelegram.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrlText)}&text=${weatherText}`;
            
            // Show modal
            shareModal.classList.remove('hidden');
        }
        
        // Copy share link to clipboard
        function copyShareLink() {
            shareUrl.select();
            
            try {
                navigator.clipboard.writeText(shareUrl.value);
                copyLink.innerHTML = '<i class="ti ti-check"></i>';
                setTimeout(() => {
                    copyLink.innerHTML = '<i class="ti ti-copy"></i>';
                }, 2000);
            } catch (err) {
                console.error("Clipboard error:", err);
                // Fallback using document.execCommand
                document.execCommand('copy');
                copyLink.innerHTML = '<i class="ti ti-check"></i>';
                setTimeout(() => {
                    copyLink.innerHTML = '<i class="ti ti-copy"></i>';
                }, 2000);
            }
        }
        
        // Toggle favorite status of current location
        function toggleFavorite() {
            if (!currentLocationData) return;
            
            const favoriteIcon = favoriteButton.querySelector('i');
            const isFavorite = favoriteIcon.classList.contains('text-yellow-500');
            
            if (isFavorite) {
                // Remove from favorites
                favoriteIcon.classList.remove('text-yellow-500');
                
                // Update favorites list
                userPreferences.favorites = userPreferences.favorites.filter(fav => 
                    !(Math.abs(fav.latitude - currentLocationData.latitude) < 0.01 && 
                     Math.abs(fav.longitude - currentLocationData.longitude) < 0.01)
                );
            } else {
                // Add to favorites with animation
                favoriteIcon.classList.add('text-yellow-500', 'favorite-animation');
                setTimeout(() => favoriteIcon.classList.remove('favorite-animation'), 300);
                
                // Check if location is coordinates-only
                const isCoordinates = /[0-9.-]+¬∞/.test(currentLocationData.displayName);
                
                // If it's just coordinates, suggest naming it
                if (isCoordinates) {
                    showLocationNameModal();
                }
                
                // Add to favorites list
                const favorite = {
                    displayName: currentLocationData.displayName,
                    name: currentLocationData.name || currentLocationData.displayName,
                    latitude: currentLocationData.latitude,
                    longitude: currentLocationData.longitude,
                    country: currentLocationData.country
                };
                
                // Check if already exists
                const exists = userPreferences.favorites.some(fav => 
                    Math.abs(fav.latitude - favorite.latitude) < 0.01 && 
                    Math.abs(fav.longitude - favorite.longitude) < 0.01
                );
                
                if (!exists) {
                    userPreferences.favorites.push(favorite);
                }
            }
            
            // Save preferences
            saveUserPreferences();
            
            // Update favorites UI
            renderFavorites();
            
            // Show favorites container if there are favorites
            if (userPreferences.favorites.length > 0) {
                favoritesContainer.classList.remove('hidden');
            } else {
                favoritesContainer.classList.add('hidden');
            }
        }
        
        // Render favorites list
        function renderFavorites() {
            favoritesList.innerHTML = '';
            
            // Create favorite buttons
            userPreferences.favorites.forEach(favorite => {
                const button = document.createElement('button');
                button.className = 'px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full text-sm text-gray-800 dark:text-white transition-colors';
                button.textContent = favorite.displayName;
                button.addEventListener('click', () => {
                    getWeatherByCoordinates(favorite.latitude, favorite.longitude, favorite.displayName);
                });
                favoritesList.appendChild(button);
            });
        }
        
        // Open favorites management modal
        function openFavoritesModal() {
            favoritesManagementList.innerHTML = '';
            
            if (userPreferences.favorites.length === 0) {
                noFavorites.classList.remove('hidden');
            } else {
                noFavorites.classList.add('hidden');
                
                // Create list items for each favorite
                userPreferences.favorites.forEach((favorite, index) => {
                    const li = document.createElement('li');
                    li.className = 'py-3 flex justify-between items-center';
                    li.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-gray-800 dark:text-white">${favorite.displayName}</span>
                            <button class="text-gray-500 hover:text-primary edit-btn" data-index="${index}">
                                <i class="ti ti-pencil text-sm"></i>
                            </button>
                        </div>
                        <button class="text-red-500 hover:text-red-700 dark:hover:text-red-400 delete-btn" data-index="${index}">
                            <i class="ti ti-trash text-xl"></i>
                        </button>
                    `;
                    
                    // Add delete handler
                    const deleteButton = li.querySelector('.delete-btn');
                    deleteButton.addEventListener('click', () => {
                        userPreferences.favorites.splice(index, 1);
                        saveUserPreferences();
                        li.remove();
                        
                        // Update favorites UI
                        renderFavorites();
                        
                        // Check if favorites is now empty
                        if (userPreferences.favorites.length === 0) {
                            noFavorites.classList.remove('hidden');
                            favoritesContainer.classList.add('hidden');
                        }
                    });
                    
                    // Add edit handler
                    const editButton = li.querySelector('.edit-btn');
                    editButton.addEventListener('click', () => {
                        const fav = userPreferences.favorites[index];
                        
                        // Set current location data to this favorite
                        currentLocationData = {
                            latitude: fav.latitude,
                            longitude: fav.longitude,
                            displayName: fav.displayName
                        };
                        
                        // Open rename modal
                        showLocationNameModal();
                    });
                    
                    favoritesManagementList.appendChild(li);
                });
            }
            
            favoritesModal.classList.remove('hidden');
        }
        
        // Display weather data on the page
        function displayWeatherData(data, locationNameStr) {
            try {
                console.log("Displaying weather data for:", locationNameStr);
                
                // Save weather data for reference
                currentWeatherData = data;
                
                // Current weather data
                const current = {
                    temperature: formatTemperature(data.current.temperature_2m),
                    feelsLike: formatTemperature(data.current.apparent_temperature || data.current.temperature_2m),
                    weatherCode: data.current.weather_code,
                    humidity: `${data.current.relative_humidity_2m}%`,
                    windSpeed: data.current.wind_speed_10m,
                    windDirection: data.current.wind_direction_10m,
                    uvIndex: data.current.uv_index || "N/A"
                };
                
                // Check if location is in favorites
                const isFavorite = userPreferences.favorites.some(fav => 
                    Math.abs(fav.latitude - currentLocationData.latitude) < 0.01 && 
                    Math.abs(fav.longitude - currentLocationData.longitude) < 0.01
                );
                
                const favoriteIcon = favoriteButton.querySelector('i');
                if (isFavorite) {
                    favoriteIcon.classList.add('text-yellow-500');
                } else {
                    favoriteIcon.classList.remove('text-yellow-500');
                }
                
                // Display current weather
                locationName.textContent = locationNameStr;
                weatherDescription.textContent = currentLanguage === 'en' ? 
                    weatherDescriptions[current.weatherCode] : 
                    weatherDescriptionsFa[current.weatherCode];
                weatherIconContainer.textContent = weatherIcons[current.weatherCode];
                temperature.textContent = current.temperature;
                feelsLike.textContent = current.feelsLike;
                humidity.textContent = current.humidity;
                wind.textContent = formatWind(current.windSpeed, current.windDirection);
                
                // Update weather details
                if (data.current.uv_index !== undefined) {
                    document.getElementById('uv-index').textContent = data.current.uv_index.toFixed(1);
                }
                if (data.daily && data.daily.precipitation_sum) {
                    document.getElementById('precipitation').textContent = `${data.daily.precipitation_sum[0]} mm`;
                }
                if (data.daily && data.daily.sunrise && data.daily.sunset) {
                    document.getElementById('sunrise').textContent = formatTime(data.daily.sunrise[0]);
                    document.getElementById('sunset').textContent = formatTime(data.daily.sunset[0]);
                }
                
                // Update wind compass
                updateWindCompass(current.windDirection);
                
                // Check for weather alerts with enhanced information
                checkWeatherAlerts(data);
                
                // Display historical comparison (simulated)
                const historicalTemps = [
                    data.current.temperature_2m - 2 + Math.random() * 4,
                    data.current.temperature_2m - 3 + Math.random() * 6,
                    data.current.temperature_2m - 5 + Math.random() * 10
                ];
                const avgHistorical = historicalTemps.reduce((a, b) => a + b, 0) / historicalTemps.length;
                const diff = data.current.temperature_2m - avgHistorical;
                const absDiff = Math.abs(diff);
                
                let comparisonText;
                if (currentLanguage === 'en') {
                    if (absDiff < 2) {
                        comparisonText = `Current temperature is about average for this time of year.`;
                    } else if (diff > 0) {
                        comparisonText = `${formatTemperature(absDiff)} warmer than the historical average for this time.`;
                    } else {
                        comparisonText = `${formatTemperature(absDiff)} cooler than the historical average for this time.`;
                    }
                } else {
                    if (absDiff < 2) {
                        comparisonText = `ÿØŸÖÿß€å ŸÅÿπŸÑ€å ÿ™ŸÇÿ±€åÿ®ÿßŸã ŸÖÿ™Ÿàÿ≥ÿ∑ ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿ≤ŸÖÿßŸÜ ÿßÿ≤ ÿ≥ÿßŸÑ ÿßÿ≥ÿ™.`;
                    } else if (diff > 0) {
                        comparisonText = `${formatTemperature(absDiff)} ⁄Øÿ±ŸÖ‚Äåÿ™ÿ± ÿßÿ≤ ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ÿ™ÿßÿ±€åÿÆ€å ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿ≤ŸÖÿßŸÜ.`;
                    } else {
                        comparisonText = `${formatTemperature(absDiff)} ÿ≥ÿ±ÿØÿ™ÿ± ÿßÿ≤ ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ÿ™ÿßÿ±€åÿÆ€å ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿ≤ŸÖÿßŸÜ.`;
                    }
                }
                
                document.getElementById('historical-text').textContent = comparisonText;
                
                // Display hourly forecast (next 24 hours)
                hourlyForecastContent.innerHTML = '';
                
                if (data.hourly && data.hourly.time) {
                    // Get current hour index
                    const now = new Date();
                    const currentHourIndex = data.hourly.time.findIndex(time => {
                        const timeDate = new Date(time);
                        return timeDate > now;
                    }) - 1;
                    
                    // Display next 24 hours
                    const startIndex = Math.max(0, currentHourIndex);
                    const endIndex = Math.min(startIndex + 24, data.hourly.time.length);
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        const hourData = {
                            time: formatTime(data.hourly.time[i]),
                            temp: formatTemperature(data.hourly.temperature_2m[i]),
                            weatherCode: data.hourly.weather_code?.[i] || 0,
                            precipitation: data.hourly.precipitation_probability?.[i] || 0
                        };
                        
                        const hourElement = document.createElement('div');
                        hourElement.className = 'flex-shrink-0 w-16 bg-gray-50 dark:bg-gray-700 p-2 rounded-lg text-center';
                        hourElement.innerHTML = `
                            <div class="text-xs font-medium text-gray-800 dark:text-white">${hourData.time}</div>
                            <div class="text-xl my-1">${weatherIcons[hourData.weatherCode]}</div>
                            <div class="text-sm text-gray-800 dark:text-white">${hourData.temp}</div>
                            <div class="text-xs text-blue-500 mt-1">${hourData.precipitation}%</div>
                        `;
                        hourlyForecastContent.appendChild(hourElement);
                    }
                }
                
                // Display 7-day forecast
                forecastContent.innerHTML = '';
                
                if (data.daily && data.daily.time) {
                    const forecastDays = Math.min(data.daily.time.length, 7);
                    
                    for (let i = 0; i < forecastDays; i++) {
                        const day = {
                            date: formatDate(data.daily.time[i]),
                            weatherCode: data.daily.weather_code[i],
                            maxTemp: data.daily.temperature_2m_max[i],
                            minTemp: data.daily.temperature_2m_min[i],
                            precipitation: data.daily.precipitation_sum?.[i] || 0
                        };
                        
                        const dayElement = document.createElement('div');
                        dayElement.className = 'flex-shrink-0 w-28 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center';
                        
                        const precipText = currentLanguage === 'en' ? 
                            (day.precipitation > 0 ? day.precipitation + ' mm' : 'No rain') : 
                            (day.precipitation > 0 ? day.precipitation + ' ŸÖ€åŸÑ€å‚ÄåŸÖÿ™ÿ±' : 'ÿ®ÿØŸàŸÜ ÿ®ÿßÿ±ÿ¥');
                        
                        dayElement.innerHTML = `
                            <div class="font-medium text-gray-800 dark:text-white mb-1 truncate">${day.date}</div>
                            <div class="text-2xl mb-1">${weatherIcons[day.weatherCode]}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300 truncate">${currentLanguage === 'en' ? weatherDescriptions[day.weatherCode] : weatherDescriptionsFa[day.weatherCode]}</div>
                            <div class="text-sm text-gray-800 dark:text-white mt-1">${formatTemperature(day.maxTemp)} / ${formatTemperature(day.minTemp)}</div>
                            <div class="text-xs text-blue-500 mt-1">${precipText}</div>
                        `;
                        forecastContent.appendChild(dayElement);
                    }
                }
                
                // Create temperature chart
                if (data.daily && data.daily.time) {
                    createTemperatureChart(data.daily);
                }
                
                // Show the weather container
                weatherContainer.classList.remove('hidden');
                
                // Apply user preferences to UI after displaying weather
                updateUIBasedOnPreferences();
            } catch (err) {
                console.error("Error displaying weather data:", err);
                showError(currentLanguage === 'en' ? 
                    "Failed to display weather data. Please try again." : 
                    "ŸÜŸÖÿß€åÿ¥ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¢ÿ® Ÿà ŸáŸàÿß ÿ®ÿß ÿ¥⁄©ÿ≥ÿ™ ŸÖŸàÿßÿ¨Ÿá ÿ¥ÿØ. ŸÑÿ∑ŸÅÿß ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.");
            }
        }

        // Show loading indicator
        function showLoading(message = "Loading weather data...") {
            loadingText.textContent = message;
            loadingContainer.classList.remove('hidden');
            weatherContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            loadingContainer.classList.add('hidden');
            permissionText.style.display = 'none';
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            weatherContainer.classList.add('hidden');
            hideLoading();
        }

        // IMPROVED: Fetch location coordinates with fallback mechanism
        async function getCoordinates(locationName) {
            try {
                console.log("Getting coordinates for:", locationName);
                
                // Determine which API to try first based on user location
                if (isIranianIP) {
                    try {
                        // First try Open-Meteo for Iranian users
                        const response = await fetchWithTimeout(
                            `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationName)}&count=1&language=${currentLanguage}`,
                            { timeout: 3000 }
                        );
                        const data = await response.json();
                        
                        if (data.results && data.results.length > 0) {
                            const location = data.results[0];
                            return {
                                latitude: location.latitude,
                                longitude: location.longitude,
                                name: location.name,
                                country: location.country,
                                displayName: `${location.name}, ${location.country}`
                            };
                        }
                    } catch (error) {
                        console.log("Open-Meteo geocoding failed, trying OpenWeatherMap");
                    }
                }
                
                // Try OpenWeatherMap API (or as fallback for Iranian users)
                try {
                    const response = await fetchWithTimeout(
                        `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(locationName)}&limit=1&appid=4d8fb5b93d4af21d66a2948710284366`,
                        { timeout: 3000 }
                    );
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const location = data[0];
                        return {
                            latitude: location.lat,
                            longitude: location.lon,
                            name: location.name,
                            country: location.country,
                            displayName: `${location.name}, ${location.country}`
                        };
                    }
                } catch (error) {
                    console.error("OpenWeatherMap geocoding failed");
                    
                    // If we're in Iran and both APIs fail, show a specific error
                    if (isIranianIP) {
                        throw new Error(currentLanguage === 'en' ? 
                            "Network issues detected. Please check your connection or try a different location." : 
                            "ŸÖÿ¥⁄©ŸÑÿßÿ™ ÿ¥ÿ®⁄©Ÿá ÿ¥ŸÜÿßÿ≥ÿß€å€å ÿ¥ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿßÿ™ÿµÿßŸÑ ÿÆŸàÿØ ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ€åÿØ €åÿß ŸÖ⁄©ÿßŸÜ ÿØ€å⁄Øÿ±€å ÿ±ÿß ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©ŸÜ€åÿØ.");
                    }
                }
                
                throw new Error(currentLanguage === 'en' ? 
                    "Location not found" : 
                    "ŸÖ⁄©ÿßŸÜ €åÿßŸÅÿ™ ŸÜÿ¥ÿØ");
            } catch (err) {
                console.error("Geocoding error:", err);
                throw new Error(err.message || (currentLanguage === 'en' ? 
                    "Could not find coordinates for this location" : 
                    "ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜ ŸÖÿÆÿ™ÿµÿßÿ™ ÿß€åŸÜ ŸÖ⁄©ÿßŸÜ ÿ±ÿß Ÿæ€åÿØÿß ⁄©ÿ±ÿØ"));
            }
        }

        // IMPROVED: Get weather data with region-specific optimizations
        async function getWeatherByLocationName(locationName) {
            const loadingMsg = currentLanguage === 'en' ? 
                "Finding location..." : 
                "ÿØÿ± ÿ≠ÿßŸÑ €åÿßŸÅÿ™ŸÜ ŸÖ⁄©ÿßŸÜ...";
            
            showLoading(loadingMsg);
            
            try {
                // Get coordinates from location name
                const locationData = await getCoordinates(locationName);
                
                // Save current location data
                currentLocationData = locationData;
                
                const weatherLoadingMsg = currentLanguage === 'en' ? 
                    "Getting weather data..." : 
                    "ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ¢ÿ® Ÿà ŸáŸàÿß...";
                
                showLoading(weatherLoadingMsg);
                
                // Get weather data
                const weatherData = await fetchWeatherData(
                    locationData.latitude, 
                    locationData.longitude
                );
                
                // Display the weather
                displayWeatherData(weatherData, locationData.displayName);
                hideLoading();
                
                // Update map if it exists
                if (map) {
                    map.setView([locationData.latitude, locationData.longitude], 10);
                    
                    // FIXED: Always remove old marker before adding a new one
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([locationData.latitude, locationData.longitude]).addTo(map);
                }
            } catch (err) {
                showError(err.message);
            }
        }

        // Get weather for coordinates
        async function getWeatherByCoordinates(latitude, longitude, displayName) {
            const loadingMsg = currentLanguage === 'en' ? 
                "Getting weather data..." : 
                "ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ¢ÿ® Ÿà ŸáŸàÿß...";
            
            showLoading(loadingMsg);
            
            try {
                // Check for custom name
                const locationKey = `${latitude.toFixed(4)},${longitude.toFixed(4)}`;
                const customName = userPreferences.customLocationNames[locationKey];
                
                // Save current location data
                currentLocationData = {
                    latitude,
                    longitude,
                    displayName: customName || displayName || `${latitude.toFixed(2)}¬∞, ${longitude.toFixed(2)}¬∞`
                };
                
                // Try to get location name if it's coordinates-based
                if (displayName.includes('¬∞') && !customName) {
                    try {
                        // Try to get the real location name if we don't have a custom name
                        let locationName = null;
                        
                        // Try to get location name based on region
                        if (isIranianIP) {
                            try {
                                // Use Open-Meteo for Iranian users
                                const response = await fetchWithTimeout(
                                    `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&language=${currentLanguage}`,
                                    { timeout: 3000 }
                                );
                                const data = await response.json();
                                
                                if (data.features && data.features.length > 0) {
                                    const location = data.features[0].properties;
                                    // Construct location name from available properties
                                    const nameParts = [];
                                    if (location.name) nameParts.push(location.name);
                                    if (location.city) nameParts.push(location.city);
                                    if (location.country) nameParts.push(location.country);
                                    
                                    locationName = nameParts.join(', ');
                                }
                            } catch (error) {
                                console.log("Open-Meteo reverse geocoding failed");
                            }
                        }
                        
                        // If we didn't get a name or are not in Iran, try OpenWeatherMap
                        if (!locationName) {
                            try {
                                const response = await fetchWithTimeout(
                                    `https://api.openweathermap.org/geo/1.0/reverse?lat=${latitude}&lon=${longitude}&limit=1&appid=4d8fb5b93d4af21d66a2948710284366`,
                                    { timeout: 3000 }
                                );
                                const data = await response.json();
                                
                                if (data && data.length > 0) {
                                    const location = data[0];
                                    locationName = `${location.name}, ${location.country}`;
                                }
                            } catch (error) {
                                console.error("OpenWeatherMap reverse geocoding failed");
                            }
                        }
                        
                        // If we got a real location name, update the current location data
                        if (locationName) {
                            currentLocationData.displayName = locationName;
                            // Don't save this as a custom name since it came from the API
                        }
                    } catch (error) {
                        console.error("Error getting location name:", error);
                    }
                }
                
                // Get weather data
                const weatherData = await fetchWeatherData(latitude, longitude);
                
                // Display the weather
                displayWeatherData(weatherData, currentLocationData.displayName);
                hideLoading();
            } catch (err) {
                showError(err.message);
            }
        }

        // IMPROVED: Fetch weather data with multiple API backups
        async function fetchWeatherData(latitude, longitude) {
            try {
                console.log("Fetching weather data for:", latitude, longitude);
                
                // Always use Open-Meteo for weather data as it's reliable worldwide
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,uv_index&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset&timezone=auto`;
                
                try {
                    const response = await fetchWithTimeout(url, { timeout: 5000 });
                    
                    if (!response.ok) {
                        throw new Error(`Weather API error: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error("Open-Meteo API error:", error);
                    
                    // If Open-Meteo fails, try OpenWeatherMap as a backup for weather data
                    try {
                        // This is a simplified adaptation that maps OpenWeatherMap data to Open-Meteo format
                        const owmUrl = `https://api.openweathermap.org/data/2.5/onecall?lat=${latitude}&lon=${longitude}&exclude=minutely&units=metric&appid=4d8fb5b93d4af21d66a2948710284366`;
                        const response = await fetchWithTimeout(owmUrl, { timeout: 5000 });
                        
                        if (!response.ok) {
                            throw new Error(`OpenWeatherMap API error: ${response.status}`);
                        }
                        
                        const owmData = await response.json();
                        
                        // Map OpenWeatherMap data to Open-Meteo format
                        return convertOwmToOpenMeteo(owmData);
                    } catch (owmError) {
                        console.error("OpenWeatherMap API error:", owmError);
                        throw new Error(currentLanguage === 'en' ? 
                            "All weather services are currently unavailable. Please try again later." : 
                            "ŸáŸÖŸá ÿ≥ÿ±Ÿà€åÿ≥‚ÄåŸáÿß€å ÿ¢ÿ® Ÿà ŸáŸàÿß ÿØÿ± ÿ≠ÿßŸÑ ÿ≠ÿßÿ∂ÿ± ÿØÿ± ÿØÿ≥ÿ™ÿ±ÿ≥ ŸÜ€åÿ≥ÿ™ŸÜÿØ. ŸÑÿ∑ŸÅÿß ÿ®ÿπÿØÿß ÿØŸàÿ®ÿßÿ±Ÿá ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©ŸÜ€åÿØ.");
                    }
                }
            } catch (err) {
                console.error("Weather API error:", err);
                throw new Error(err.message || (currentLanguage === 'en' ? 
                    "Could not fetch weather data" : 
                    "ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜ ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ¢ÿ® Ÿà ŸáŸàÿß ÿ±ÿß ÿØÿ±€åÿßŸÅÿ™ ⁄©ÿ±ÿØ"));
            }
        }
        
        // IMPROVED: Convert OpenWeatherMap data to Open-Meteo format for consistent handling
        function convertOwmToOpenMeteo(owmData) {
            // Map OWM weather codes to WMO codes (approximate conversion)
            function mapWeatherCode(owmId) {
                // These are approximate mappings
                if (owmId >= 200 && owmId < 300) return 95; // Thunderstorm
                if (owmId >= 300 && owmId < 400) return 51; // Drizzle
                if (owmId >= 500 && owmId < 510) return 61; // Rain
                if (owmId >= 510 && owmId < 520) return 66; // Freezing rain
                if (owmId >= 520 && owmId < 600) return 80; // Showers
                if (owmId >= 600 && owmId < 700) return 71; // Snow
                if (owmId >= 700 && owmId < 800) return 45; // Fog
                if (owmId === 800) return 0; // Clear
                if (owmId > 800) return 2; // Partly cloudy
                return 3; // Default to overcast
            }
            
            // Create daily arrays
            const dailyData = {
                time: [],
                weather_code: [],
                temperature_2m_max: [],
                temperature_2m_min: [],
                precipitation_sum: [],
                sunrise: [],
                sunset: []
            };
            
            // Fill daily data
            for (let i = 0; i < Math.min(7, owmData.daily.length); i++) {
                const day = owmData.daily[i];
                dailyData.time.push(new Date(day.dt * 1000).toISOString().split('T')[0]);
                dailyData.weather_code.push(mapWeatherCode(day.weather[0].id));
                dailyData.temperature_2m_max.push(day.temp.max);
                dailyData.temperature_2m_min.push(day.temp.min);
                dailyData.precipitation_sum.push(day.rain || 0);
                dailyData.sunrise.push(new Date(day.sunrise * 1000).toISOString());
                dailyData.sunset.push(new Date(day.sunset * 1000).toISOString());
            }
            
            // Create hourly arrays
            const hourlyData = {
                time: [],
                temperature_2m: [],
                weather_code: [],
                precipitation_probability: []
            };
            
            // Fill hourly data
            for (let i = 0; i < Math.min(24, owmData.hourly.length); i++) {
                const hour = owmData.hourly[i];
                hourlyData.time.push(new Date(hour.dt * 1000).toISOString());
                hourlyData.temperature_2m.push(hour.temp);
                hourlyData.weather_code.push(mapWeatherCode(hour.weather[0].id));
                hourlyData.precipitation_probability.push(hour.pop * 100); // Convert from 0-1 to percentage
            }
            
            // Create current data
            const current = {
                temperature_2m: owmData.current.temp,
                apparent_temperature: owmData.current.feels_like,
                relative_humidity_2m: owmData.current.humidity,
                weather_code: mapWeatherCode(owmData.current.weather[0].id),
                wind_speed_10m: owmData.current.wind_speed,
                wind_direction_10m: owmData.current.wind_deg,
                uv_index: owmData.current.uvi
            };
            
            // Return in Open-Meteo format
            return {
                current,
                hourly: hourlyData,
                daily: dailyData
            };
        }

        // Initialize app when DOM is loaded
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
