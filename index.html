<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open-Meteo Weather App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .weather-icon {
            font-size: 4rem;
            text-align: center;
        }
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(93, 92, 222, 0.3);
            border-radius: 50%;
            border-top-color: #5D5CDE;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Dark mode styles */
        .dark .weather-card {
            background-color: #2d2d2d;
            color: #f1f1f1;
        }
        .dark .input-field {
            background-color: #3d3d3d;
            color: #ffffff;
        }
        #map { 
            height: 300px; 
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1; /* Ensure proper z-index for map controls */
        }
        .forecast-container {
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #5D5CDE #f0f0f0;
        }
        .forecast-container::-webkit-scrollbar {
            height: 8px;
        }
        .forecast-container::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }
        .forecast-container::-webkit-scrollbar-thumb {
            background-color: #5D5CDE;
            border-radius: 4px;
        }
        .dark .forecast-container::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        .location-tab {
            position: relative;
            cursor: pointer;
        }
        .location-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #5D5CDE;
        }
        .dark .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }
        .dark .leaflet-container {
            background: #333;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div class="container mx-auto px-4 py-6 max-w-xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800 dark:text-white">Weather App</h1>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
            <div class="flex border-b dark:border-gray-700">
                <button id="searchTab" class="location-tab flex-1 py-3 text-center text-gray-800 dark:text-white font-medium active">
                    Search Location
                </button>
                <button id="mapTab" class="location-tab flex-1 py-3 text-center text-gray-800 dark:text-white font-medium">
                    Pin on Map
                </button>
            </div>
            
            <div id="searchPanel" class="p-6">
                <form id="weatherForm" class="flex flex-col md:flex-row gap-2">
                    <input 
                        type="text" 
                        id="locationInput" 
                        placeholder="City, mountain, desert, sea coordinates..." 
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
                        required
                    >
                    <button 
                        type="submit" 
                        class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                    >
                        Search
                    </button>
                </form>
            </div>
            
            <div id="mapPanel" class="hidden p-4">
                <div id="map" class="mb-4"></div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    Click anywhere on the map to get weather for that exact location (mountains, deserts, seas, etc.).
                </p>
                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <span class="text-gray-700 dark:text-gray-300">Selected point:</span>
                    <span id="selectedLocation" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-full text-sm text-gray-800 dark:text-white">None selected</span>
                </div>
                <button 
                    id="getWeatherForLocation" 
                    class="w-full px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50"
                    disabled
                >
                    Get Weather
                </button>
            </div>
        </div>
        
        <div id="loadingContainer" class="flex justify-center items-center py-10">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-700 dark:text-gray-300" id="loadingText">Getting your location...</p>
            </div>
        </div>

        <div id="weatherContainer" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div id="weatherHeader" class="p-6 flex flex-col md:flex-row items-center gap-4">
                <div id="weatherIconContainer" class="flex-shrink-0 weather-icon"></div>
                <div class="flex-1">
                    <h2 id="locationName" class="text-2xl font-bold text-gray-800 dark:text-white mb-1"></h2>
                    <p id="weatherDescription" class="text-gray-600 dark:text-gray-300 mb-3"></p>
                    <div class="flex flex-wrap gap-x-6 gap-y-2">
                        <div class="flex items-center">
                            <span class="text-gray-700 dark:text-gray-300 font-medium">Temperature:</span>
                            <span id="temperature" class="ml-2 text-gray-900 dark:text-white"></span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-700 dark:text-gray-300 font-medium">Humidity:</span>
                            <span id="humidity" class="ml-2 text-gray-900 dark:text-white"></span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-700 dark:text-gray-300 font-medium">Wind:</span>
                            <span id="wind" class="ml-2 text-gray-900 dark:text-white"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="forecastContainer" class="border-t border-gray-200 dark:border-gray-700 p-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">7-Day Forecast</h3>
                <div class="forecast-container pb-2">
                    <div id="forecastContent" class="flex gap-3 min-w-full"></div>
                </div>
            </div>
        </div>
        
        <div id="errorContainer" class="hidden bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-100 p-4 rounded-lg mt-4">
            <p id="errorMessage"></p>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Weather code to icon mapping for Open-Meteo
        const weatherIcons = {
            // Clear, Sunny
            0: '‚òÄÔ∏è', // Clear sky
            1: 'üå§Ô∏è', // Mainly clear
            2: '‚õÖ', // Partly cloudy
            3: '‚òÅÔ∏è', // Overcast
            
            // Fog, Mist
            45: 'üå´Ô∏è', // Fog
            48: 'üå´Ô∏è', // Depositing rime fog
            
            // Drizzle
            51: 'üåßÔ∏è', // Light drizzle
            53: 'üåßÔ∏è', // Moderate drizzle
            55: 'üåßÔ∏è', // Dense drizzle
            
            // Freezing Drizzle
            56: 'üåßÔ∏è', // Light freezing drizzle
            57: 'üåßÔ∏è', // Dense freezing drizzle
            
            // Rain
            61: 'üåßÔ∏è', // Slight rain
            63: 'üåßÔ∏è', // Moderate rain
            65: 'üåßÔ∏è', // Heavy rain
            
            // Freezing Rain
            66: 'üå®Ô∏è', // Light freezing rain
            67: 'üå®Ô∏è', // Heavy freezing rain
            
            // Snow
            71: '‚ùÑÔ∏è', // Slight snow fall
            73: '‚ùÑÔ∏è', // Moderate snow fall
            75: '‚ùÑÔ∏è', // Heavy snow fall
            
            // Snow Grains
            77: '‚ùÑÔ∏è', // Snow grains
            
            // Rain Showers
            80: 'üå¶Ô∏è', // Slight rain showers
            81: 'üå¶Ô∏è', // Moderate rain showers
            82: 'üå¶Ô∏è', // Violent rain showers
            
            // Snow Showers
            85: 'üå®Ô∏è', // Slight snow showers
            86: 'üå®Ô∏è', // Heavy snow showers
            
            // Thunderstorm
            95: '‚õàÔ∏è', // Thunderstorm
            96: '‚õàÔ∏è', // Thunderstorm with slight hail
            99: '‚õàÔ∏è', // Thunderstorm with heavy hail
            
            // Default
            undefined: 'üå°Ô∏è'
        };

        // WMO Weather interpretation codes to text descriptions
        const weatherDescriptions = {
            0: "Clear sky",
            1: "Mainly clear",
            2: "Partly cloudy",
            3: "Overcast",
            45: "Fog",
            48: "Depositing rime fog",
            51: "Light drizzle",
            53: "Moderate drizzle",
            55: "Dense drizzle",
            56: "Light freezing drizzle",
            57: "Dense freezing drizzle",
            61: "Slight rain",
            63: "Moderate rain",
            65: "Heavy rain",
            66: "Light freezing rain",
            67: "Heavy freezing rain",
            71: "Slight snow fall",
            73: "Moderate snow fall",
            75: "Heavy snow fall",
            77: "Snow grains",
            80: "Slight rain showers",
            81: "Moderate rain showers",
            82: "Violent rain showers",
            85: "Slight snow showers",
            86: "Heavy snow showers",
            95: "Thunderstorm",
            96: "Thunderstorm with slight hail",
            99: "Thunderstorm with heavy hail",
            undefined: "Unknown"
        };

        // DOM Elements
        const weatherForm = document.getElementById('weatherForm');
        const locationInput = document.getElementById('locationInput');
        const weatherContainer = document.getElementById('weatherContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingText = document.getElementById('loadingText');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const locationName = document.getElementById('locationName');
        const weatherDescription = document.getElementById('weatherDescription');
        const weatherIconContainer = document.getElementById('weatherIconContainer');
        const temperature = document.getElementById('temperature');
        const humidity = document.getElementById('humidity');
        const wind = document.getElementById('wind');
        const forecastContent = document.getElementById('forecastContent');
        const searchTab = document.getElementById('searchTab');
        const mapTab = document.getElementById('mapTab');
        const searchPanel = document.getElementById('searchPanel');
        const mapPanel = document.getElementById('mapPanel');
        const selectedLocation = document.getElementById('selectedLocation');
        const getWeatherForLocation = document.getElementById('getWeatherForLocation');

        // Map variables
        let map;
        let marker;
        let selectedCoords = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add click handler
            map.on('click', function(e) {
                const { lat, lng } = e.latlng;
                selectedCoords = { lat, lng };
                
                // Update or add marker
                if (marker) {
                    marker.setLatLng(e.latlng);
                } else {
                    marker = L.marker(e.latlng).addTo(map);
                }
                
                // Update UI
                selectedLocation.textContent = `${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞`;
                getWeatherForLocation.disabled = false;
            });
            
            // Refresh map on tab change (fixes rendering issues)
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        // Tab switching
        searchTab.addEventListener('click', () => {
            searchTab.classList.add('active');
            mapTab.classList.remove('active');
            searchPanel.classList.remove('hidden');
            mapPanel.classList.add('hidden');
        });
        
        mapTab.addEventListener('click', () => {
            mapTab.classList.add('active');
            searchTab.classList.remove('active');
            mapPanel.classList.remove('hidden');
            searchPanel.classList.add('hidden');
            
            if (!map) {
                initMap();
            } else {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        });

        // Format temperature with units
        function formatTemperature(temp) {
            return `${Math.round(temp)}¬∞C`;
        }

        // Format date string from ISO date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }

        // Convert wind speed and direction to human-readable format
        function formatWind(speed, direction) {
            // Converting m/s to km/h
            const speedKmh = Math.round(speed * 3.6);
            
            // Get cardinal direction
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(direction / 45) % 8;
            
            return `${speedKmh} km/h ${directions[index]}`;
        }

        // Display weather data on the page
        function displayWeatherData(data, locationName) {
            try {
                // Current weather data
                const current = {
                    temperature: formatTemperature(data.current.temperature_2m),
                    weatherCode: data.current.weather_code,
                    humidity: `${data.current.relative_humidity_2m}%`,
                    windSpeed: data.current.wind_speed_10m,
                    windDirection: data.current.wind_direction_10m
                };
                
                // Display current weather
                document.getElementById('locationName').textContent = locationName;
                weatherDescription.textContent = weatherDescriptions[current.weatherCode];
                weatherIconContainer.textContent = weatherIcons[current.weatherCode];
                temperature.textContent = current.temperature;
                humidity.textContent = current.humidity;
                wind.textContent = formatWind(current.windSpeed, current.windDirection);
                
                // Display 7-day forecast
                forecastContent.innerHTML = '';
                
                if (data.daily && data.daily.time) {
                    const forecastDays = Math.min(data.daily.time.length, 7);
                    
                    for (let i = 0; i < forecastDays; i++) {
                        const day = {
                            date: formatDate(data.daily.time[i]),
                            weatherCode: data.daily.weather_code[i],
                            maxTemp: data.daily.temperature_2m_max[i],
                            minTemp: data.daily.temperature_2m_min[i]
                        };
                        
                        const dayElement = document.createElement('div');
                        dayElement.className = 'flex-shrink-0 w-28 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center';
                        dayElement.innerHTML = `
                            <div class="font-medium text-gray-800 dark:text-white mb-1 truncate">${day.date}</div>
                            <div class="text-2xl mb-1">${weatherIcons[day.weatherCode]}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300 truncate">${weatherDescriptions[day.weatherCode]}</div>
                            <div class="text-sm text-gray-800 dark:text-white mt-1">${formatTemperature(day.maxTemp)} / ${formatTemperature(day.minTemp)}</div>
                        `;
                        forecastContent.appendChild(dayElement);
                    }
                    
                    document.getElementById('forecastContainer').style.display = 'block';
                } else {
                    document.getElementById('forecastContainer').style.display = 'none';
                }
                
                // Show the weather container
                weatherContainer.classList.remove('hidden');
            } catch (err) {
                console.error("Error displaying weather data:", err);
                showError("Failed to display weather data. Please try again.");
            }
        }

        // Show loading indicator
        function showLoading(message = "Loading weather data...") {
            loadingText.textContent = message;
            loadingContainer.classList.remove('hidden');
            weatherContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            loadingContainer.classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            weatherContainer.classList.add('hidden');
            hideLoading();
        }

        // Fetch location coordinates from name using Open-Meteo Geocoding API
        async function getCoordinates(locationName) {
            try {
                const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationName)}&count=1`);
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error("Location not found");
                }
                
                const location = data.results[0];
                return {
                    latitude: location.latitude,
                    longitude: location.longitude,
                    name: location.name,
                    country: location.country,
                    displayName: `${location.name}, ${location.country}`
                };
            } catch (err) {
                console.error("Geocoding error:", err);
                throw new Error("Could not find coordinates for this location");
            }
        }

        // Fetch weather data from Open-Meteo API
        async function fetchWeatherData(latitude, longitude) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }
                
                return await response.json();
            } catch (err) {
                console.error("Weather API error:", err);
                throw new Error("Could not fetch weather data");
            }
        }

        // Get weather for a location (by name)
        async function getWeatherByLocationName(locationName) {
            showLoading("Finding location...");
            
            try {
                // Get coordinates from location name
                const locationData = await getCoordinates(locationName);
                
                showLoading("Getting weather data...");
                
                // Get weather data
                const weatherData = await fetchWeatherData(
                    locationData.latitude, 
                    locationData.longitude
                );
                
                // Display the weather
                displayWeatherData(weatherData, locationData.displayName);
                hideLoading();
                
                // Update map if it exists
                if (map) {
                    map.setView([locationData.latitude, locationData.longitude], 10);
                    
                    if (marker) {
                        marker.setLatLng([locationData.latitude, locationData.longitude]);
                    } else {
                        marker = L.marker([locationData.latitude, locationData.longitude]).addTo(map);
                    }
                }
            } catch (err) {
                showError(err.message);
            }
        }

        // Get weather for coordinates
        async function getWeatherByCoordinates(latitude, longitude, displayName) {
            showLoading("Getting weather data...");
            
            try {
                // Get weather data
                const weatherData = await fetchWeatherData(latitude, longitude);
                
                // Display the weather
                displayWeatherData(weatherData, displayName || `${latitude.toFixed(2)}¬∞, ${longitude.toFixed(2)}¬∞`);
                hideLoading();
            } catch (err) {
                showError(err.message);
            }
        }

        // Weather form submission
        weatherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const location = locationInput.value.trim();
            
            if (!location) {
                showError("Please enter a location");
                return;
            }
            
            await getWeatherByLocationName(location);
        });

        // Get weather for map location
        getWeatherForLocation.addEventListener('click', () => {
            if (selectedCoords) {
                const { lat, lng } = selectedCoords;
                const displayName = `${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞`;
                getWeatherByCoordinates(lat, lng, displayName);
            }
        });

        // Get user's location on page load
        window.addEventListener('DOMContentLoaded', () => {
            if ('geolocation' in navigator) {
                showLoading('Getting your location...');
                
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    getWeatherByCoordinates(latitude, longitude, 'Your Current Location');
                    
                    // Save coordinates for later use with the map
                    if (!map) {
                        // We'll initialize map with these coordinates when/if the user switches to map tab
                        window.userCoordinates = { latitude, longitude };
                    } else {
                        map.setView([latitude, longitude], 10);
                    }
                }, error => {
                    console.error("Geolocation error:", error);
                    hideLoading();
                    // Don't show an error, just let the user search manually
                });
            } else {
                hideLoading();
                // Don't show an error, just let the user search manually
            }
        });

        // Initialize map when tab is first clicked
        mapTab.addEventListener('click', () => {
            if (!map) {
                initMap();
                
                // If we have user coordinates, center the map there
                if (window.userCoordinates) {
                    const { latitude, longitude } = window.userCoordinates;
                    map.setView([latitude, longitude], 10);
                    
                    // Add a marker for user's location
                    L.marker([latitude, longitude])
                        .addTo(map)
                        .bindPopup('Your Location')
                        .openPopup();
                }
            }
        });
    </script>
</body>
</html>
